PÃ©riode : 14â€“15 dÃ©cembre 2025

ğŸ§¾ 4. Paiements Stripe / PayPal

- Flow Stripe finalisÃ© :
  - POST /api/payments/checkout crÃ©e la session Checkout Stripe.
  - Retour Stripe sur /checkout/stripe-success?session_id=â€¦ .
  - GET /api/payments/stripe/confirm :
    - rÃ©cupÃ¨re la session Stripe (expand payment_intent),
    - vÃ©rifie payment_status/status,
    - met Ã  jour payment_transactions (status = 'succeeded', ids Stripe),
    - met Ã  jour obituaries (payment_provider = 'stripe', amount_paid, currency).
  - Page /checkout/stripe-success affiche un rÃ©cap clair (montant, annonce, #payment_id).

- Flow PayPal :
  - Copie du modÃ¨le Stripe (handler /api/payments/paypal/confirm + page /checkout/paypal-success).
  - Ã€ fiabiliser / tester en conditions rÃ©elles (sandbox).

ğŸ“ 5. Documents justificatifs & stockage Swiss Backup

- Ajout dâ€™une section â€œDocuments justificatifsâ€ sur la page /obituary/confirm/[slug] :
  - PiÃ¨ce dâ€™identitÃ© du dÃ©clarant (id_card),
  - Certificat de dÃ©cÃ¨s (death_certificate).
- Tant que les deux documents ne sont pas fournis, le bouton â€œConfirmer et payerâ€ reste dÃ©sactivÃ©.
- Nouvelle table (concept) obituary_documents :
  - obituary_id, user_id, type (id_card | death_certificate | other),
  - file_url (URL S3), status, admin_note, timestamps.
- Nouveau handler POST /api/obituaries/[slug]/documents :
  - requireAuth + contrÃ´le des droits (proprio annonce ou admin/moderator),
  - lecture du multipart/form-data,
  - validation type & taille (images + PDF, max 10 Mo),
  - upload dans Swiss Backup (S3 compatible) sur lâ€™appareil madizi-docs,
  - upsert dans obituary_documents (UNIQUE (obituary_id, type)),
  - renvoi de la liste Ã  jour des documents.

- Infra :
  - Swiss Backup (Sauvegarde Cloud) activÃ© chez Infomaniak.
  - Appareil S3 â€œmadizi-docsâ€ crÃ©Ã©.
  - IntÃ©gration S3 dans le handler via @aws-sdk/client-s3 et variables dâ€™environnement :
    - S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET=madizi-docs, S3_REGION=us-east-1.

ğŸ§­ 6. Prochaines Ã©tapes (court terme)

- Fiabiliser PayPal :
  - tester le flow complet sandbox,
  - vÃ©rifier lâ€™update de payment_transactions et obituaries,
  - peaufiner les messages de succÃ¨s/erreur.

- Confirmation & docs :
  - charger les documents existants au chargement de la page (GET /api/obituaries/:slug/documents),
  - reflÃ©ter cet Ã©tat cÃ´tÃ© UI (badge â€œdocs dÃ©jÃ  transmisâ€).

- PrÃ©parer la modÃ©ration :
  - dÃ©finir prÃ©cisÃ©ment lâ€™usage de verification_status (pending / verified / rejected),
  - prÃ©voir les Ã©crans â€œMes annoncesâ€ (user) et â€œObituaries Ã  validerâ€ (admin). 


///
Journal de dev â€“ Matanga / Madizi

PÃ©riode : 18â€“19 dÃ©cembre 2025

1. Flux cÃ´tÃ© famille â€“ crÃ©ation / Ã©dition / confirmation
1.1 Page de confirmation /obituary/confirm/[slug].vue

Mise en place dâ€™un rÃ©cap complet de lâ€™annonce :

Bloc dÃ©funt (nom, dates, Ã¢ge affichÃ©, religion, localisation, rural/urbainâ€¦)

Texte dâ€™annonce (titre + corps)

Liste des Ã©vÃ©nements (type, date/heure, lieu, Ã©vÃ©nement principal)

Liste des contacts (contact principal, tÃ©lÃ©phone, WhatsApp, email)

Ajout du bloc â€œDocuments justificatifsâ€ :

Gestion des deux types :

id_card (piÃ¨ce dâ€™identitÃ©)

death_certificate (certificat de dÃ©cÃ¨s)

Affichage :

Badge vert si dÃ©jÃ  uploadÃ© + lien â€œvoir le fichierâ€

Badge orange si manquant, avec bouton dâ€™upload (image/PDF)

Logique dâ€™upload :

POST /api/obituaries/:slug/documents via FormData

Refresh automatique de la liste de documents aprÃ¨s upload

Toasts success / error en cas de problÃ¨me dâ€™upload

RÃ¨gle mÃ©tier CNI / certificat :

CNI = obligatoire pour dÃ©clencher le paiement.

Certificat de dÃ©cÃ¨s = optionnel pendant 7 jours, mais suivi :

hasAllRequiredDocs = basÃ© uniquement sur la CNI.

Calcul isCertOverdue :

compare now Ã  created_at

si >= 7 jours et pas de death_certificate â†’ considÃ©rÃ© en retard.

certDeadlineLabel = date limite affichÃ©e formatÃ©e.

Message dâ€™avertissement renforcÃ© si le certificat est en retard.

IntÃ©gration avec les plans :

Mini PLAN_META cÃ´tÃ© front (codes : indiv_free_7, indiv_basic_21, indiv_essentiel_30, indiv_prestige_60).

Correction : plan gratuit = 14 jours de publication (alignÃ© avec la DB)
â†’ publishDurationDays du plan gratuit passÃ© Ã  14.

Affichage cohÃ©rent dans le panneau latÃ©ral :

Formule

DurÃ©e de publication

Montant (Gratuit ou prix en â‚¬)

Panneau latÃ©ral : logique des boutons :

Plan gratuit : bouton â€œPublier gratuitementâ€ qui appelle POST /api/obituaries/:slug/publish puis redirige vers la page publique.

Plan payant :

Si non payÃ© + non publiÃ© : bouton â€œConfirmer et payerâ€ â†’ redirect vers /checkout/obituary/:slug (avec le plan en query si dispo).

Si dÃ©jÃ  payÃ© / dÃ©jÃ  publiÃ© : texte adaptÃ© (â€œLe paiement pour cette annonce a dÃ©jÃ  Ã©tÃ© enregistrÃ©â€), sans renvoyer vers le paiement.

Boutons de gestion :

Modifier lâ€™annonce â†’ redirection vers /obituary/edit/[slug].

Archiver (soft delete) : DELETE /api/obituaries/:slug â†’ statut archivÃ© / privÃ©, avec toasts.

Suppression dÃ©finitive (hard delete) : DELETE /api/obituaries/:slug/hard.

Les deux actions passent par un ConfirmModal via useConfirmStore avant dâ€™exÃ©cuter lâ€™API.

2. Page dâ€™Ã©dition /obituary/edit/[slug].vue

RÃ©cupÃ©ration de la payload via GET /api/obituaries/:slug (obituary + events + contacts) et prÃ©-remplissage du formulaire :

DÃ©funts : nom complet, dates naissance/dÃ©cÃ¨s, Ã¢ge, genre, statut dâ€™identification, religion, dÃ©nomination.

Localisation : ville, rÃ©gion, pays, code pays, rural/urbain.

Contenu : titre, texte dâ€™annonce, langue principale.

Image de couverture : coverImageUrl (nouveau champ).

Ã‰vÃ©nement principal :

type (funeral, wake, burial, memorial)

startsAt au bon format datetime-local

lieu (nom + adresse)

Contact principal famille :

nom / label

tÃ©lÃ©phone

WhatsApp

email

Image de couverture :

Nouveau champ coverImageUrl dans le formulaire.

AperÃ§u en live si lâ€™URL est renseignÃ©e (petite vignette sous le champ).

Ce champ est inclus dans le payload envoyÃ© au backend.

Validation minimale alignÃ©e avec la crÃ©ation :

Nom du dÃ©funt obligatoire.

Titre â‰¥ longueur minimale.

Corps de texte â‰¥ ~40 caractÃ¨res.

Date/heure de lâ€™Ã©vÃ©nement principal obligatoire.

Build du payload PUT /api/obituaries/:slug :

On nâ€™y touche pas Ã  la monÃ©tisation / plan.

On envoie :

champs plats (dÃ©funts, localisation, titre, contenu, coverImageUrlâ€¦)

un seul event principal (isMainEvent = true)

un contact principal public + primary si rempli.

Navigation & actions :

Bouton Annuler â†’ retour vers /obituary/confirm/:slug.

Bouton Enregistrer â†’ PUT, puis retour vers la page de confirmation avec toast de succÃ¨s.

Bouton Supprimer depuis lâ€™Ã©dition :

ConfirmModal via useConfirmStore

DELETE /api/obituaries/:slug (archive)

redirection vers /obituaries.

3. Espace admin â€“ modÃ©ration & vÃ©rification
3.1 API server/api/admin/obituaries/[id]/verification.post.js

Debug du fichier (erreur â€œExpected finally but found elseâ€) â†’ rÃ©Ã©criture propre et structurÃ©e du handler.

RÃ¨gle mÃ©tier mise au clair et implÃ©mentÃ©e :

Action verify :

VÃ©rifie lâ€™existence de lâ€™annonce (SELECT).

Met Ã  jour :

verification_status = 'verified'

verification_note = note

status :

si draft / pending_review / rejected â†’ passe Ã  published

visibility :

si on vÃ©rifie une annonce non publiÃ©e â†’ public

si dÃ©jÃ  published mais private â†’ forcÃ©e Ã  public
ğŸ‘‰ corrige le bug oÃ¹ les annonces payÃ©es restaient invisibles.

publish_at â†’ COALESCE(publish_at, NOW())

published_at â†’ set Ã  NOW() si encore NULL

expires_at recalculÃ© avec publish_duration_days (si prÃ©sent).

Envoi dâ€™une notification in-app :

type obituary.documents.verified

message explicite : â€œVos documents justificatifs ont Ã©tÃ© acceptÃ©s. Votre annonce est dÃ©sormais publique et visibleâ€¦â€.

Action reject :

verification_status = 'rejected'

status = 'rejected'

verification_note = note

Envoi dâ€™une notification obituary.documents.rejected avec la raison facultative pour la famille.

3.2 Page admin /pages/admin/obituaries/index.vue

Filtrage & liste :

Filtres de vÃ©rification : all, pending, verified, rejected.

Recherche par nom dÃ©funt / titre / email.

Tri : rÃ©cent, plus ancien, populaire.

ParamÃ¨tre onlyPaid = true par dÃ©faut â†’ cette page admin vise les annonces avec paiement.

Appel API GET /api/admin/obituaries :

Pagination via page / pageSize.

Filtrage par status, verification_status, texte, tri, paiement.

Affichage des cartes :

Titre de lâ€™annonce.

Pills :

statut fonctionnel (draft, pending_review, published, etc.)

Ã©tat de vÃ©rification

pill paiement (montant payÃ© + devise) si amountPaid > 0.

Infos dÃ©funt + localisation.

Infos famille (email + ville/pays utilisateur).

Dates : crÃ©ation + Ã©ventuellement publication.

Plan tarifaire (pricingTier) formatÃ© via i18n.

Actions par annonce :

Lien vers la page publique /obituary/:slug (nouvel onglet).

Lien vers la page famille /obituary/confirm/:slug (nouvel onglet).

Bouton Valider :

ConfirmModal via useConfirmStore.

Appelle POST /api/admin/obituaries/:id/verification avec action = 'verify'.

GÃ¨re les Ã©tats de chargement par processingId / processingAction.

Bouton Refuser :

ConfirmModal + prompt texte (raison du refus).

Appelle la mÃªme API avec action = 'reject' + note.

Toasts de succÃ¨s / erreur sur les actions admin.

4. VÃ©rifications DB & cohÃ©rence des statuts

RequÃªtes dâ€™inspection sur la table obituaries pour comprendre les incohÃ©rences :

Liste globale : statut, visibilitÃ©, paiement, vÃ©rification, durÃ©e de publication, dates.

Focus sur :

annonces payantes mais non publiques (published + private)

annonces gratuites pour confirmer que la durÃ©e est bien 14 jours en DB.

Constat :

Plusieurs annonces payantes avec :

status = 'published'

verification_status = 'verified'

mais visibility = 'private'
â†’ corrigÃ© par la nouvelle logique dans verification.post.js + un UPDATE SQL pour les lignes existantes.

Patch SQL proposÃ© pour corriger les anciennes donnÃ©es :

UPDATE obituaries
SET
  visibility = 'public',
  published_at = COALESCE(published_at, publish_at, NOW())
WHERE is_free = 0
  AND status = 'published'
  AND visibility = 'private'
  AND verification_status = 'verified';


VÃ©rification que les annonces gratuites ont bien :

is_free = 1

publish_duration_days = 14

cohÃ©rence avec pricing_tier (indiv_free_7 / free_basic).

5. Pagination

Relecture du composant <Pagination> :

Navigation prÃ©cÃ©dente / suivante.

Liste de pages avec ellipses.

RÃ©sumÃ© â€œXâ€“Y sur Z rÃ©sultatsâ€.

Champ â€œAller Ã  la pageâ€ (input numÃ©rique synchronisÃ© avec la page courante).

Import & utilisation confirmÃ©s dans /admin/obituaries pour la pagination de la liste admin.

6. TODO / pistes pour la suite

Mettre en place (ou vÃ©rifier) la logique backend qui :

archive ou bascule lâ€™annonce si aucun certificat aprÃ¨s 7 jours (rÃ¨gle â€œcertificat obligatoire passÃ© le dÃ©laiâ€).

Ajouter Ã©ventuellement un filtre â€œonlyPaid = falseâ€ dans la page admin pour voir aussi les gratuites / tests.

RÃ©vision des textes i18n (FR + autres langues) pour :

bien reflÃ©ter â€œGratuit 14 joursâ€

messages clairs quand â€œPaiement dÃ©jÃ  enregistrÃ©â€

messages docs en retard / obligatoires.
