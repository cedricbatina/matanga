PÃ©riode : 14â€“15 dÃ©cembre 2025

ğŸ§¾ 4. Paiements Stripe / PayPal

- Flow Stripe finalisÃ© :
  - POST /api/payments/checkout crÃ©e la session Checkout Stripe.
  - Retour Stripe sur /checkout/stripe-success?session_id=â€¦ .
  - GET /api/payments/stripe/confirm :
    - rÃ©cupÃ¨re la session Stripe (expand payment_intent),
    - vÃ©rifie payment_status/status,
    - met Ã  jour payment_transactions (status = 'succeeded', ids Stripe),
    - met Ã  jour obituaries (payment_provider = 'stripe', amount_paid, currency).
  - Page /checkout/stripe-success affiche un rÃ©cap clair (montant, annonce, #payment_id).

- Flow PayPal :
  - Copie du modÃ¨le Stripe (handler /api/payments/paypal/confirm + page /checkout/paypal-success).
  - Ã€ fiabiliser / tester en conditions rÃ©elles (sandbox).

ğŸ“ 5. Documents justificatifs & stockage Swiss Backup

- Ajout dâ€™une section â€œDocuments justificatifsâ€ sur la page /obituary/confirm/[slug] :
  - PiÃ¨ce dâ€™identitÃ© du dÃ©clarant (id_card),
  - Certificat de dÃ©cÃ¨s (death_certificate).
- Tant que les deux documents ne sont pas fournis, le bouton â€œConfirmer et payerâ€ reste dÃ©sactivÃ©.
- Nouvelle table (concept) obituary_documents :
  - obituary_id, user_id, type (id_card | death_certificate | other),
  - file_url (URL S3), status, admin_note, timestamps.
- Nouveau handler POST /api/obituaries/[slug]/documents :
  - requireAuth + contrÃ´le des droits (proprio annonce ou admin/moderator),
  - lecture du multipart/form-data,
  - validation type & taille (images + PDF, max 10 Mo),
  - upload dans Swiss Backup (S3 compatible) sur lâ€™appareil madizi-docs,
  - upsert dans obituary_documents (UNIQUE (obituary_id, type)),
  - renvoi de la liste Ã  jour des documents.

- Infra :
  - Swiss Backup (Sauvegarde Cloud) activÃ© chez Infomaniak.
  - Appareil S3 â€œmadizi-docsâ€ crÃ©Ã©.
  - IntÃ©gration S3 dans le handler via @aws-sdk/client-s3 et variables dâ€™environnement :
    - S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET=madizi-docs, S3_REGION=us-east-1.

ğŸ§­ 6. Prochaines Ã©tapes (court terme)

- Fiabiliser PayPal :
  - tester le flow complet sandbox,
  - vÃ©rifier lâ€™update de payment_transactions et obituaries,
  - peaufiner les messages de succÃ¨s/erreur.

- Confirmation & docs :
  - charger les documents existants au chargement de la page (GET /api/obituaries/:slug/documents),
  - reflÃ©ter cet Ã©tat cÃ´tÃ© UI (badge â€œdocs dÃ©jÃ  transmisâ€).

- PrÃ©parer la modÃ©ration :
  - dÃ©finir prÃ©cisÃ©ment lâ€™usage de verification_status (pending / verified / rejected),
  - prÃ©voir les Ã©crans â€œMes annoncesâ€ (user) et â€œObituaries Ã  validerâ€ (admin).
