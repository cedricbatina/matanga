ğŸ§  Journal de dÃ©veloppement â€” Matanga

Date : 12 dÃ©cembre 2025
Sujet principal : Paiements (Bank transfer, Stripe, PayPal) + checkout flow

âœ… AvancÃ©es rÃ©alisÃ©es
1. Architecture paiement (backend)

CrÃ©ation et validation de la table payment_transactions

Support multi-provider : bank_transfer, stripe, paypal

Champs clÃ©s : provider, method, status, amount, currency,
external_payment_id, external_charge_id, metadata, timestamps

Mise en place dâ€™un endpoint unique :

POST /api/payments/checkout

ResponsabilitÃ©s :

vÃ©rifier ownership (owner / admin / moderator)

vÃ©rifier que lâ€™annonce est payante

crÃ©er une transaction de paiement

retourner soit :

des instructions bancaires (bank transfer)

une redirectUrl (Stripe / PayPal)

2. Bank transfer (âœ… fonctionnel)

GÃ©nÃ©ration dâ€™une rÃ©fÃ©rence unique (MAT-{obituaryId}-{random})

Insertion transaction pending en DB

Mise Ã  jour de lâ€™annonce (payment_provider, payment_reference)

Retour au front dâ€™un payload complet :

iban, bic, holder, reference, amountFormatted

Affichage correct des instructions cÃ´tÃ© UI

3. Stripe (quasi OK)

CrÃ©ation correcte dâ€™une Stripe Checkout Session

Enregistrement de la transaction Stripe en DB (pending)

URLs configurÃ©es :

success_url = /checkout/stripe-success?session_id=...

cancel_url = /checkout/stripe-cancel?...

Endpoint backend valide, logs OK (Checkout created (stripe))

4. PayPal (prÃ©parÃ©)

Flow OAuth2 + crÃ©ation dâ€™Order PayPal

RÃ©cupÃ©ration du lien approve

Enregistrement de la transaction PayPal en DB

Retour dâ€™une redirectUrl vers PayPal

âš ï¸ DifficultÃ©s rencontrÃ©es (importantes)
1. Confusion front â†” backend sur les rÃ©ponses

Erreur front trompeuse : Invalid bank transfer response

causÃ©e par :

res vide

ou Failed to fetch

ou redirection Stripe non gÃ©rÃ©e correctement

Correction : rendre le startPayment plus robuste

vÃ©rifier redirectUrl avant tout

ne pas throw trop tÃ´t

logger les payloads inattendus

2. Redirection Stripe non visible cÃ´tÃ© UI

Backend crÃ©ait bien la session Stripe

MAIS le front ne redirigeait pas toujours

Causes probables identifiÃ©es :

rebuild Nitro / HMR au moment du fetch

Service Worker / PWA encore actif en dev

Failed to fetch masquÃ© par le code front

Solution :

window.location.assign(res.redirectUrl)

dÃ©sactiver / unregister SW en dev

tester via http://localhost:3004 uniquement

3. IncohÃ©rences DB / query()

Selon les helpers DB :

parfois query() retourne rows

parfois [rows, fields]

Correction :

normalisation systÃ©matique des rÃ©sultats (normalizeRows)

4. Fatigue cognitive / complexitÃ©

Beaucoup dâ€™aller-retours entre :

pages confirm, checkout, stripe-success

API obituaries, payments, publish

DÃ©cision : sâ€™arrÃªter ici, tout est prÃªt structurellement

ğŸ§± Ã‰tat actuel du systÃ¨me

âœ… Bank transfer : OK

ğŸŸ¡ Stripe : session crÃ©Ã©e, redirection Ã  finaliser/stabiliser

ğŸŸ¡ PayPal : order crÃ©Ã©, redirection prÃªte

âŒ Pas encore fait :

webhook Stripe (payment_intent.succeeded)

confirmation PayPal (capture)

mise Ã  jour automatique payment_transactions.status

publication automatique de lâ€™annonce aprÃ¨s paiement

pages paypal-success / paypal-cancel

factures / reÃ§us

notifications (admin / user)

ğŸ§­ Prochaine Ã©tape (pour le prochain chat)

Stabiliser dÃ©finitivement le front startPayment

Finaliser :

/checkout/stripe-success

/api/payments/stripe/confirm

Ajouter les webhooks Stripe

Publier automatiquement lâ€™annonce aprÃ¨s paiement confirmÃ©

Ensuite seulement : UX, mails, notifications, factures