ğŸ“… Session du 8 dÃ©cembre 2025 â€” Flow annonces nÃ©crologiques (crÃ©ation / confirmation / Ã©dition)
1. API obituaries â€” normalisation & statuts

Fichiers concernÃ©s :

server/api/obituaries/index.get.js

server/api/obituaries/[slug].get.js

Ce quâ€™on a fait :

Mise en place dâ€™une structure de rÃ©ponse normalisÃ©e pour une annonce :

{
  obituary: { ... },   // mÃ©ta & contenu de lâ€™annonce
  events: [ ... ],     // Ã©vÃ©nements associÃ©s
  contacts: [ ... ],   // contacts famille / organisation
  media: [ ... ]       // future extension
}


mapObituaryRow(row) construit dÃ©sormais un objet obituary riche, avec sous-blocs :

deceased: fullName, dateOfBirth, dateOfDeath, ageDisplay, gender, identityStatus, religion, denominationâ€¦

location: city, region, country, countryCode, isRuralArea

monetization: isFree, pricingTier, currency, amountPaid, publishDurationDays

status, visibility, verificationStatus, moderationStatus, publishedAt, expiresAt, deletedAt, etc.

index.get.js :

Liste par dÃ©faut uniquement les annonces publiÃ©es et visibles publiquement :

status = 'published'

moderation_status != 'removed'

visibility = 'public'

published_at <= NOW() et (si prÃ©sent) expires_at > NOW()

PrÃ©pare le terrain pour filtrer plus finement Ã  lâ€™avenir (owner, admin, moderatorâ€¦).

events et contacts sont renvoyÃ©s sous forme de tableaux normalisÃ©s (startsAt, venueName, venueAddress, isMainEvent, whatsappNumber, isPrimary, etc.).

âœ… RÃ©sultat : la page publique, la page de confirmation et la page dâ€™Ã©dition parlent maintenant toutes le mÃªme â€œlangage JSONâ€.

2. Page de confirmation /obituary/confirm/[slug].vue

Ce quâ€™on a fait :

Passage Ã  lâ€™utilisation de la payload normalisÃ©e :

obituary â†’ obituary.deceased, obituary.location, obituary.monetization, obituary.content

events â†’ timeline simple (type, date/heure, lieu, adresse)

contacts â†’ liste des contacts avec phone, whatsappNumber, email

Section â€œInformations sur le dÃ©funtâ€ :

Affiche dÃ©sormais proprement :

Nom complet

Genre (avec mapping vers les labels i18n)

Niveau dâ€™identification

Dates de naissance / dÃ©cÃ¨s

Ã‚ge affichÃ©

Religion + dÃ©nomination

Localisation + code pays

Indication â€œzone rurale / villageâ€ (Oui / Non)

Bloc â€œTexte de lâ€™annonceâ€ :

Utilise obituary.content.title et obituary.content.body au lieu des anciens champs plats.

Bloc Ã©vÃ©nements :

Utilise les clÃ©s dâ€™API normalisÃ©es (eventType, startsAt, venueName, venueAddress, isMainEvent).

Formatage de la date/heure cÃ´tÃ© front.

Bloc contacts :

Liste des contacts avec name/label + canaux : tÃ©lÃ©phone, WhatsApp, email.

Plan & monÃ©tisation cÃ´tÃ© colonne droite :

Mini PLAN_META cÃ´tÃ© front, alignÃ© sur les plans individuels :

indiv_free_7, indiv_basic_21, indiv_essentiel_30, indiv_prestige_60

Logique de rÃ©solution du plan :

On privilÃ©gie obituary.monetization.pricingTier.

Fallback sur ?plan= dans lâ€™URL si nÃ©cessaire.

effectivePublishDays :

PrioritÃ© aux jours dÃ©finis dans PLAN_META.

Sinon fallback sur ce que renvoie lâ€™API (publishDurationDays).

Pour les plans gratuits, on force une durÃ©e cohÃ©rente avec indiv_free_7 (7 jours) tant que la DB nâ€™est pas corrigÃ©e.

planPrice :

Si on connaÃ®t le plan : on calcule Ã  partir de basePriceCents.

Sinon : fallback sur le montant amountPaid Ã©ventuellement renvoyÃ© par lâ€™API.

Si gratuit â†’ affiche plans.price.free.

Sinon montant inconnu â†’ â€”.

Boutons dâ€™action :

Modifier lâ€™annonce â†’ redirige vers /obituary/edit/[slug].

Publier gratuitement (plan gratuit) :

Pour lâ€™instant : stub qui dÃ©clenchera plus tard un appel Ã  un endpoint /publish.

Confirmer et payer (plan payant) :

Stub branchÃ© sur un futur flow de paiement.

3. Page dâ€™Ã©dition /obituary/edit/[slug].vue

Ce quâ€™on a fait :

Nouvelle page protÃ©gÃ©e par middleware: ['auth'].

Chargement des donnÃ©es via useFetch('/api/obituaries/:slug'), en exploitant la mÃªme payload que la page de confirmation.

Formulaire dâ€™Ã©dition alignÃ© sur le formulaire de crÃ©ation (/obituary/create) :

Bloc dÃ©funt (nom, dates, Ã¢ge, genre, identitÃ©, religion, dÃ©nomination).

Localisation (ville, rÃ©gion, pays, code pays, zone rurale).

Texte de lâ€™annonce (titre, body).

Ã‰vÃ©nement principal (type, date/heure, lieu, adresse).

Contact famille (nom, tÃ©lÃ©phone, WhatsApp, email).

Hydratation du formulaire :

watch(obituary) pour remplir form dÃ¨s que lâ€™annonce arrive.

RÃ©cupÃ©ration :

val.deceased â†’ champs dÃ©funt,

val.location â†’ city, region, country, countryCode, isRuralArea,

val.content/val.body â†’ titre + texte,

events[0] ou event avec isMainEvent â†’ Ã©vÃ©nement Ã  Ã©diter,

contact primaire (isPrimary) â†’ contact famille.

Validation :

Nom du dÃ©funt obligatoire.

Titre min 8 caractÃ¨res.

Body min 40 caractÃ¨res.

Date/heure de lâ€™Ã©vÃ©nement principal obligatoire.

Soumission :

PUT /api/obituaries/:slug avec payload â€œÃ©ditableâ€ uniquement :

infos dÃ©funt,

contenu,

localisation,

Ã©vÃ©nement principal,

contact principal.

Pas de modification de la monÃ©tisation / plan Ã  ce stade.

Retour aprÃ¨s succÃ¨s :

Redirection vers /obituary/confirm/:slug.

4. Toasts & messages dâ€™erreur

Plugins / composables :

Utilisation du plugin vue-toastification existant (app/plugins/toastification.js).

Dans lâ€™Ã©dition :

AprÃ¨s un PUT rÃ©ussi â†’ toast de succÃ¨s (editObituary.toasts.updated).

En cas dâ€™erreurs (gÃ©nÃ©riques) â†’ toast dâ€™erreur.

i18n proposÃ© (Ã  ajouter cÃ´tÃ© fr.json, par ex.) :

{
  "editObituary": {
    "toasts": {
      "updated": "Lâ€™annonce a Ã©tÃ© mise Ã  jour avec succÃ¨s."
    },
    "errors": {
      "generic": "Une erreur est survenue lors de la mise Ã  jour de lâ€™annonce.",
      "forbidden": "Vous nâ€™Ãªtes pas autorisÃ© Ã  modifier cette annonce.",
      "notFound": "Annonce introuvable ou supprimÃ©e.",
      "loadFailed": "Impossible de charger lâ€™annonce pour le moment."
    },
    "actions": {
      "retry": "RÃ©essayer",
      "cancel": "Annuler",
      "save": "Enregistrer les modifications",
      "saving": "Enregistrement en coursâ€¦"
    }
  },
  "toasts": {
    "obituary": {
      "paymentTodo": "Le paiement en ligne nâ€™est pas encore disponible sur cette version.",
      "publishFreeTodo": "La publication dÃ©finitive des annonces gratuites sera branchÃ©e sur un endpoint dÃ©diÃ©."
    }
  }
}

5. Date utils & formats

Composant concernÃ© : composables/useDateUtils.js

Rappel : on dispose dÃ©jÃ  de helpers pour lâ€™affichage :

formatDate, formattedDate, formattedDateTimeWithSeconds, formattedHourMinute, timeAgo, etc.

Session du jour :

DÃ©cision de centraliser la logique de conversion pour :

datetime-local (Ã©vÃ©nements),

date (dates de naissance / dÃ©cÃ¨s).

Helpers prÃ©vus / utilisÃ©s dans la page dâ€™Ã©dition :

toDateInput(date) â†’ YYYY-MM-DD pour <input type="date">.

toDateTimeLocalInput(date) â†’ YYYY-MM-DDTHH:mm pour <input type="datetime-local">.

normalizeDateTimeLocal(value) â†’ repasser en YYYY-MM-DD HH:mm:ss pour lâ€™API.

âœ… RÃ©sultat : moins de code ad hoc dans les pages, moins de bugs â€œ13h30 vs 14h30â€ liÃ©s aux conversions de fuseaux / formats.

6. Soft delete / hard delete â€” design (Ã  finaliser)

Ã‰lÃ©ments en place / en rÃ©flexion :

Composant de confirmation gÃ©nÃ©rique : components/LkConfirmModal.vue + useConfirmStore.

Objectif : rÃ©utiliser pour :

soft delete dâ€™une annonce (la rendre non publique),

hard delete (suppression dÃ©finitive par admin/moderator).

CÃ´tÃ© API :

Route DELETE /api/obituaries/:slug existante :

Ã  confirmer / adapter pour faire soft delete par dÃ©faut (deleted_at + statut â€œdeletedâ€) ;

hard delete Ã©ventuellement rÃ©servÃ© aux administrateurs (flag ou route dÃ©diÃ©e).

CÃ´tÃ© UI (Ã  brancher dans une prochaine session) :

Boutons â€œSupprimer lâ€™annonceâ€ dans :

/obituary/[slug] (dÃ©tail public, pour lâ€™owner via zone privÃ©e),

/obituary/confirm/[slug],

/obituary/edit/[slug].

Utilisation de LkConfirmModal pour demander confirmation Ã  lâ€™utilisateur avant toute suppression.

7. TODO / prochaines Ã©tapes

Endpoint de publication :

CrÃ©er POST /api/obituaries/:slug/publish :

vÃ©rifie owner / admin / moderator ;

passe lâ€™annonce en published, renseigne published_at et la durÃ©e de visibilitÃ©.

Brancher le bouton â€œPublier gratuitementâ€ sur ce endpoint.

Upload dâ€™image de couverture :

Ajouter un champ dâ€™upload dans create et edit :

upload vers stockage externe (Cloudinary, S3 prÃ©-signÃ©â€¦),

rÃ©cupÃ©ration dâ€™une URL publique â†’ remplissage de coverImageUrl.

Afficher cette image dans :

/obituary/[slug] (hero),

/obituary/confirm/[slug].

Soft delete / hard delete cÃ´tÃ© UI :

Ajouter les boutons dâ€™action + modales de confirmation.

Brancher sur DELETE /api/obituaries/:slug (soft par dÃ©faut) et, plus tard, une route de hard delete pour les admins.

Multi-Ã©vÃ©nements / multi-contacts / mÃ©dias par plan :

Builder dâ€™Ã©vÃ©nements (jusquâ€™Ã  maxEvents selon le plan).

Gestion de plusieurs contacts (maxContacts).

PrÃ©parer la structure pour plusieurs photos / vidÃ©os (alignÃ©e s