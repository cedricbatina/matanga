Journal de dev â€“ Matanga â€“ Session du jour
1. Page de confirmation dâ€™annonce /obituary/confirm/[slug].vue

Plan / monÃ©tisation cÃ´tÃ© front

GardÃ© un mini PLAN_META cÃ´tÃ© client avec :

indiv_free_7 (7 jours, gratuit, source de vÃ©ritÃ© produit),

indiv_basic_21, indiv_essentiel_30, indiv_prestige_60.

Calcul de planCodeFromData Ã  partir de obituary.monetization.pricingTier ou du paramÃ¨tre ?plan= dans lâ€™URL.

currentPlanMeta, planLabel, planPrice, effectivePublishDays :

AlignÃ©s sur le plan front quand connu.

Fallback sur les champs renvoyÃ©s par lâ€™API (publishDurationDays, amountPaid, etc.).

Pour un plan gratuit sans info fiable venant de la DB, on force 7 jours cÃ´tÃ© UI.

Statut de publication / visibilitÃ©

La page de confirm ne publie plus implicitement :

Pour un plan gratuit, le bouton â€œConfirmer et envoyer en validationâ€ appelle dÃ©sormais un endpoint dÃ©diÃ© POST /api/obituaries/:slug/publish.

Pour un plan payant, le bouton â€œConfirmer et payerâ€ redirigera vers la future page de checkout (route /checkout/obituary/:slug), avec un toast â€œFlow paiement Ã  venirâ€.

Formatage des dates

IntÃ©gration de useDateUtils :

formatDate utilisÃ© pour afficher les dates de naissance / dÃ©cÃ¨s dans le recap :

Plus de 2025-12-07T23:00:00.000Z en brut.

Affichage en franÃ§ais lisible via i18n (â€œNÃ©(e) le {date}â€¦ DÃ©cÃ©dÃ©(e) le {date}â€¦â€).

formattedDateTimeWithSeconds utilisÃ© dans formatDateTime pour les Ã©vÃ©nements (veillÃ©es / obsÃ¨ques).

Soft delete / hard delete (archive & suppression dÃ©finitive)

Ajout de deux actions dans la colonne de droite :

ğŸ—‚ Retirer lâ€™annonce du site â†’ soft delete (DELETE /api/obituaries/:slug)

Retire lâ€™annonce de la liste publique (visibilitÃ© / statut mis Ã  jour cÃ´tÃ© API).

Redirige vers /obituaries + toast de succÃ¨s / erreur.

ğŸ—‘ Supprimer dÃ©finitivement â†’ hard delete (DELETE /api/obituaries/:slug/hard)

Suppression physique de lâ€™annonce et de ses dÃ©pendances (Ã©vÃ©nements, contactsâ€¦) cÃ´tÃ© API.

Redirection vers /obituaries + toast.

Utilisation du composant global LkConfirmModal + useConfirmStore :

onSoftDeleteClick â†’ confirmStore.ask(...) avec texte dÃ©diÃ© (titre, message, labels).

onHardDeleteClick â†’ mÃªme principe avec messages orientÃ©s â€œaction irrÃ©versibleâ€.

Labels et messages passÃ©s par i18n (obituaryReview.delete.softTitle, softMessage, hardTitle, hardMessage, common.actions.archive, common.actions.delete, etc.).

Harmonisation des boutons

Uniformisation des boutons de la colonne de droite :

â€œModifier lâ€™annonceâ€ â†’ btn btn-ghost btn-sm.

â€œConfirmer et envoyer en validationâ€ / â€œConfirmer et payerâ€ â†’ btn btn-primary.

Boutons â€œRetirer lâ€™annonce du siteâ€ et â€œSupprimer dÃ©finitivementâ€ â†’ btn btn-ghost btn-sm, avec icÃ´nes ğŸ—‚ et ğŸ—‘.

RÃ©sultat : une seule â€œgrosseâ€ action principale en btn-primary, les autres en secondaires cohÃ©rentes.

Toasts

Utilisation du plugin toastification via useNuxtApp().$useToast() :

SuccÃ¨s publication gratuite (aprÃ¨s POST /publish).

Erreur publication gratuite (404 / 500).

Info â€œflow paiement Ã  venirâ€ pour les plans payants.

ClÃ©s i18n prÃ©vues : toasts.obituary.publishFreeSuccess, toasts.obituary.publishFreeError, toasts.obituary.paymentTodo.

2. CrÃ©ation / statut cÃ´tÃ© API server/api/obituaries/index.post.js

VÃ©rification complÃ¨te de la route POST /api/obituaries

On a confirmÃ© que :

La crÃ©ation se fait bien en brouillon privÃ© :

status = 'draft'

visibility = 'private'

publish_at = NULL, published_at = NULL.

publishDirect = false.

Les champs plan / monÃ©tisation sont bien dÃ©rivÃ©s de planCode + session.accountType.

Alignement durÃ©e plan gratuit

Introduction explicite de FREE_OBITUARY_DURATION_DAYS = 7.

Quand le plan est gratuit (selectedPlan.isFree === true) :

publishDurationDaysValue forcÃ© Ã  7.

Câ€™est maintenant la source de vÃ©ritÃ© cÃ´tÃ© API, ce qui permet :

dâ€™avoir une cohÃ©rence stricte entre back et front,

de corriger implicitement les valeurs 14 jours existantes en DB Ã  terme.

3. Endpoint de publication POST /api/obituaries/:slug/publish

(Fichier ajoutÃ© aujourdâ€™hui, basÃ© sur ta convention API actuelle)

Comportement :

requireAuth(event) + vÃ©rification ownership (user = owner de lâ€™annonce) ou rÃ´le admin/modÃ©rateur.

Chargement de lâ€™obituary par slug + vÃ©rification :

status === 'draft'

visibility === 'private'

Mise Ã  jour en :

status = 'published'

visibility = 'public'

published_at = NOW()

publish_at = NOW() si null.

expires_at recalculÃ© Ã  partir de publishDurationDays (si non null).

Retour JSON simple { ok: true, obituaryId, slug, ... } pour que le front puisse Ã©ventuellement se baser dessus.

IntÃ©gration front :

onConfirm (plan gratuit) appelle maintenant rÃ©ellement cet endpoint.

Gestion des erreurs (404, 403, 500) + toasts associÃ©s.

4. Suppression / archive cÃ´tÃ© API

Soft delete : DELETE /api/obituaries/:slug

UtilisÃ© pour â€œRetirer lâ€™annonce du siteâ€ :

Statut & visibilitÃ© mis Ã  jour en mode â€œarchivÃ© / privÃ©â€ (selon ta logique existante).

Lâ€™annonce reste prÃ©sente en base pour :

historique,

Ã©ventuel republish ultÃ©rieur,

accÃ¨s par lâ€™owner.

Hard delete : DELETE /api/obituaries/:slug/hard

UtilisÃ© pour â€œSupprimer dÃ©finitivementâ€ :

Suppression de lâ€™entrÃ©e dans obituaries.

Suppression des lignes associÃ©es (Ã©vÃ©nements, contacts, et plus tard mÃ©dias).

RÃ©servÃ© Ã  lâ€™owner + admin / modÃ©rateur (contrÃ´lÃ© cÃ´tÃ© API).

5. Checkout paiement (Stripe / PayPal / virement) â€“ squelette

Objectif produit

Pour les plans payants, remplacer le â€œConfirmer et payerâ€ par un vrai flow de commande :

Page : /checkout/obituary/[slug].vue.

MÃ©thodes prÃ©vues :

Carte bancaire via Stripe (Checkout Session).

PayPal.

Virement bancaire (avec rÃ©fÃ©rence structurÃ©e, statut â€œpending_paymentâ€ en DB).

AvancÃ©es du jour

DÃ©finition de la structure de la page :

Colonne gauche : rappel annonce + plan + durÃ©e.

Colonne droite : bloc â€œMoyen de paiementâ€ + 3 boutons de choix.

Bloc â€œVirement bancaireâ€ avec infos IBAN/BIC/titulaire/rÃ©fÃ©rence + texte dâ€™explication.

Ajout des styles dÃ©diÃ©s :

checkout-layout, checkout-main__*, checkout-side__*, checkout-methods, checkout-bank__*, etc.

CohÃ©rent avec la grille et la charte de la page de confirmation.

Ajout des clÃ©s i18n checkoutObituary dans fr.json :

Titres / sous-titres,

Textes de modes de paiement,

Bloc explicatif virement,

Toast informatif pour un futur virement (checkoutObituary.bank.toastSuccess).

TODO pour demain / suite

CrÃ©er les endpoints backend :

POST /api/payments/obituaries/:slug/stripe â†’ crÃ©ation checkout_session_id Stripe.

POST /api/payments/obituaries/:slug/paypal â†’ crÃ©ation orderId.

POST /api/payments/obituaries/:slug/bank-transfer â†’ gÃ©nÃ©ration dâ€™une rÃ©fÃ©rence + marquage â€œpending_paymentâ€.

Brancher la page /checkout/obituary/[slug].vue sur ces endpoints :

Gestion loading/erreurs.

Redirections (Stripe Checkout, PayPal) cÃ´tÃ© front.

Mettre en place les webhooks :

Stripe : validation paiement, mise Ã  jour amount_paid, payment_provider, payment_reference, status, published_at.

PayPal : mÃªme logique.

Statut mÃ©tier :

draft â†’ awaiting_payment â†’ published / payment_failed.

Pour virement : awaiting_bank_transfer + Ã©cran â€œMerci, nous publierons dÃ¨s rÃ©ceptionâ€.

Harmoniser lâ€™utilisation de useDateUtils sur :

Page liste,

Page dÃ©tail annonce publique,

Eventuelles autres vues timeline.