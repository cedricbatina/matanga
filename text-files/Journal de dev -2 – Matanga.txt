Journal de dev â€“ Matanga (obituaries)
PÃ©riode : 6â€“7 dÃ©cembre 2025
ğŸ§± 1. RÃ©cap gÃ©nÃ©ral du flow obituaries

Flow â€œparticulierâ€ travaillÃ© :

/plans âœ choix dâ€™un plan (indiv_free_7, indiv_basic_21, indiv_essentiel_30, indiv_prestige_60)

/obituary/create?plan=â€¦ âœ formulaire de crÃ©ation dâ€™annonce (brouillon cÃ´tÃ© back)

/obituary/confirm/[slug] âœ page de rÃ©cap / confirmation (publication ou paiement, selon plan)

Lâ€™API POST /api/obituaries crÃ©e lâ€™annonce + events + contacts, et renvoie un slug utilisÃ© dans lâ€™URL de confirm.

ğŸ“ 2. Page crÃ©ation dâ€™annonce

pages/obituary/create/index.vue

a) Bandeau de plan & mÃ©ta locales

Ajout / refonte de PLAN_META cÃ´tÃ© front pour les plans individuels par annonce (scope obituary) :

indiv_free_7

indiv_basic_21

indiv_essentiel_30

indiv_prestige_60

Chaque plan contient :

pricingTier, isFree, publishDurationDays, currency, basePriceCents

labelKey : pointant vers plans.codes.* dans les locales

features (maxEvents, maxPhotos, maxVideos, maxContacts, etc.) alignÃ©s sur server/utils/pricingPlans.js.

SÃ©lection du plan :

On lit route.query.plan

Fallback : indiv_free_7 si rien nâ€™est fourni

Computeds :

currentPlan (Ã  partir de PLAN_META)

currentPlanLabel (via i18n)

currentPlanFeatures (avec fallback DEFAULT_PLAN_FEATURES)

selectedPlanText : phrase de synthÃ¨se du plan (nom + durÃ©e)

formatPlanPrice(plan) : affiche â€œGratuitâ€ ou â€œxx,xx â‚¬ TTCâ€.

UI :

selected-plan-banner en haut du formulaire, avec label + prix + phrase dâ€™aide.

Couleurs revues pour Ãªtre lisibles en clair et sombre.

b) Formulaire de crÃ©ation

Bloc 1 : Infos dÃ©funt

Nom complet, genre (radio), identitÃ© (connue / partielle / inconnue)

Dates (naissance, dÃ©cÃ¨s), Ã¢ge affichÃ©

Religion + dÃ©nomination

Localisation : ville, rÃ©gion, pays, code pays (2 lettres) + indicateur zone rurale.

Bloc 2 : Texte de lâ€™annonce

Titre

Corps de texte

DÃ©tection automatique du titre Ã  partir du nom si vide, avec share.obituary.titlePattern.

Validation :

deceasedFullName obligatoire

Titre min 8 caractÃ¨res

Corps min 40 caractÃ¨res

Bloc 3 : Ã‰vÃ©nement principal

Type dâ€™Ã©vÃ©nement (funeral, wake, burial, memorial)

Date/heure (datetime-local)

Lieu : nom + adresse

Validation : event.startsAt obligatoire

NouveautÃ© liÃ©e au plan :

Petit hint : plans.features.events.value avec { count: currentPlanFeatures.maxEvents }
â†’ ex. â€œJusquâ€™Ã  3 Ã©vÃ©nementsâ€ pour Essentiel, etc.

Bloc 4 : Contact famille

Nom

TÃ©lÃ©phone

WhatsApp

Email

Tout ceci est ensuite transformÃ© en entrÃ©e contacts pour lâ€™API si au moins 1 champ est rempli.

Bloc 5 : Photo & publication

URL de photo de couverture (pour lâ€™instant simple coverImageUrl)

Texte lÃ©gal de publication

Hints dynamiques :

plans.features.media.value (photos/vidÃ©os selon features du plan)

plans.features.contacts.value (nombre de contacts max)

c) Build du payload & envoi API

Fonction buildPayload() :

Mappe tous les champs du form vers les colonnes attendues par /api/obituaries :

Infos dÃ©funt

Contenu (title, content)

Localisation

Contact famille (plat + contacts[] dÃ©taillÃ©)

Plan (isFree, pricingTier, currency, amountPaid, publishDurationDays)

events: tableau avec 1 event principal :

eventType, startsAt normalisÃ© en YYYY-MM-DD HH:mm:ss

Lieu repris (venueName, venueAddress, city, region, country, countryCode)

isMainEvent: true

planCode brut (pour lookup cÃ´tÃ© serveur).

Sur succÃ¨s :

RÃ©cupÃ©ration du slug renvoyÃ© par lâ€™API

Redirection systÃ©matique vers /obituary/confirm/${slug}

En cas dâ€™erreur :

Log console + message user-friendly via i18n createObituary.errors.submitFailed.

d) Bug PLAN_META corrigÃ©

On a briÃ¨vement introduit un doublon de indiv_prestige_60 dans PLAN_META (une version complÃ¨te + une version â€œoptionnelle simplifiÃ©eâ€).

Ã‡a a cassÃ© le parsing SFC Ã  cause dâ€™un objet JS mal fermÃ©, gÃ©nÃ©rant :

[vue/compiler-sfc] Missing semicolon...

Correction :

Suppression de la seconde dÃ©finition â€œoptionnelleâ€

On garde la version complÃ¨te alignÃ©e avec pricingPlans.js.

ğŸ‘ï¸ 3. Page de confirmation / rÃ©cap

pages/obituary/confirm/[slug].vue

a) Fetch & plan client

useFetch('/api/obituaries/:slug') pour rÃ©cupÃ©rer lâ€™annonce, ses events et contacts.

PLAN_META allÃ©gÃ© cÃ´tÃ© client pour :

indiv_free_7

indiv_basic_21

indiv_essentiel_30

indiv_prestige_60

planCodeFromData lit planCode ou pricingTier depuis les donnÃ©es retour API.

currentPlanMeta = lookup dans PLAN_META.

planLabel via i18n plans.codes.*.

planPrice :

si plan gratuit â†’ plans.price.free

sinon â†’ format Ã  partir de basePriceCents ou amountPaid.

b) Layout & sections

Colonne gauche : carte principale avec sections :

Informations sur le dÃ©funt

Nom complet

Genre (formatGender)

Niveau dâ€™identification (formatIdentityStatus)

Dates naissance/dÃ©cÃ¨s (obituaryReview.fields.dates + sous-clÃ©s)

Ã‚ge affichÃ©

Religion + dÃ©nomination (formatReligion)

Localisation (ville, rÃ©gion, pays)

Code pays

Indicateur ruralitÃ© (â€œOui/Nonâ€ selon obituaryReview.fields.ruralYes/No)

Texte de lâ€™annonce

Titre

Corps du texte

Ã‰vÃ©nements

Liste events[] venant du back

Pour chaque event :

Type formatÃ© (funeral/wake/burial/memorial via i18n)

Badge â€œÃ‰vÃ©nement principalâ€ si isMainEvent

Date/heure formatÃ©e via toLocaleString(locale) avec formatDateTime

Lieu (nom + adresse)

Message â€œaucun Ã©vÃ©nementâ€ si liste vide.

Contacts

Liste contacts[]

Pour chaque contact :

Nom / label + badge â€œcontact principalâ€

TÃ©lÃ©phone, WhatsApp, email (icÃ´nes font-awesome)

Message â€œaucun contactâ€ si liste vide.

Colonne droite : sidebar plan / actions

Titre + sous-titre

RÃ©cap :

Plan (nom)

DurÃ©e (via obituaryReview.planMeta + days)

Prix (calculÃ© via planPrice)

Texte lÃ©gal obituaryReview.side.legal :

mention de vÃ©rification par lâ€™Ã©quipe Matanga / possibilitÃ© de retrait en cas de signalement (Ã  affiner cÃ´tÃ© locales).

Boutons :

â€œModifier lâ€™annonceâ€ âœ pour lâ€™instant renvoie vers /obituary/create?plan=â€¦ (TODO vraie page /obituary/edit/[slug])

Si plan gratuit â†’ bouton â€œPublier gratuitementâ€

Si plan payant â†’ bouton â€œConfirmer et payerâ€

onPay() et onConfirm() encore TODO pour brancher :

POST /api/obituaries/:slug/publish (gratuit)

Flow checkout (Stripe ou autre) (payant).

UI :

review-plan-banner harmonisÃ© avec le bandeau de plan de la crÃ©ation, fond plus doux pour mode clair.

Skeletons & messages dâ€™erreur quand pending ou error.

ğŸ” 4. Auth global & middleware Nuxt

a) Middleware backend global
server/middleware/auth.global.js

RÃ´le : remplir event.context.auth Ã  partir de getAuthSession(event).

En cas dâ€™erreur (cookie, DB, etc.) :

log de lâ€™erreur

event.context.auth = null mais on ne bloque pas la requÃªte.

b) Middleware Nuxt cÃ´tÃ© app
app/middleware/auth.js

ProblÃ¨me rencontrÃ© :

Erreur Unterminated template due Ã  un template string mal fermÃ©.

Boucle de redirection vers /login mÃªme en Ã©tant connectÃ©.

Version corrigÃ©e :

ProtÃ¨ge les routes marquÃ©es avec middleware: ['auth'] (ex : /obituary/create, /obituary/confirm/[slug]).

Ne protÃ¨ge pas /login ni /register pour Ã©viter les loops.

Appelle /api/auth/me avec credentials: 'include'.

Si non connectÃ© :

redirection vers /login?redirect=<fullPath>&reason=auth_required.

RÃ©sultat :

Quand tu es connectÃ©, tu peux aller sur /obituary/create?... et /obituary/confirm/[slug] normalement.

Quand tu ne lâ€™es pas, tu es renvoyÃ© vers login avec un message clair.

âœ… 5. Ã€ faire / prochaines Ã©tapes

Builder multi-Ã©vÃ©nements sur la page create :

Transformer le bloc â€œÃ‰vÃ©nement principalâ€ en rÃ©pÃ©teur (events[]) limitÃ© par currentPlanFeatures.maxEvents.

Flag isMainEvent sur un event au moins.

Gestion des mÃ©dias :

UI pour uploader / lier plusieurs photos (et vidÃ©os) selon maxPhotos, maxVideos, maxExternalVideoLinks.

Contacts multiples :

Permettre plusieurs contacts jusquâ€™Ã  currentPlanFeatures.maxContacts.

Endpoints de publication & paiement :

/api/obituaries/:slug/publish pour finaliser les gratuites.

Checkout pour les plans payants (prÃ©parer les routes + UI).

Plans mÃ©moriels & pro :

Pour lâ€™instant, on nâ€™utilise que les plans individuels par annonce (INDIVIDUAL_PLANS scope obituary).

IntÃ©grer les plans â€œmemorialâ€ et les plans â€œproâ€ plus tard (autres Ã©crans / flows).