Journal de dev ‚Äì Matanga
Date : 2025-12-02

Contexte g√©n√©ral

Projet : Matanga, plateforme d‚Äôannonces n√©crologiques (d√©c√®s, veill√©es, obs√®ques, hommages) pour l‚ÄôAfrique, la diaspora et les Cara√Øbes.

Tech : Nuxt 4 (SSR), MySQL, backend en JS avec requ√™tes SQL, JWT en cookies HttpOnly, Brevo (SMTP) pour l‚Äôemail.

Vision : mobile-first, th√®me clair/sombre, design haut de gamme, tr√®s bonne accessibilit√© et SEO fort.

Backend ‚Äì Authentification (API)

Table SQL ajout√©e : refresh_tokens (gestion des refresh JWT, r√©vocation, s√©curit√©).

Variables d‚Äôenvironnement ajout√©es :

JWT_ACCESS_SECRET, JWT_REFRESH_SECRET

JWT_ACCESS_EXPIRES_IN (15 min), JWT_REFRESH_EXPIRES_IN (14 jours)

Utilitaires JWT : server/utils/jwt.js

signAccessToken / signRefreshToken

verifyAccessToken / verifyRefreshToken

constantes de dur√©e (accessTokenMaxAge, refreshTokenMaxAge)

Utilitaires cookies auth : server/utils/authCookies.js

setAuthCookies(event, accessToken, refreshToken, ‚Ä¶)

clearAuthCookies(event)

noms de cookies : matanga_at (access) et matanga_rt (refresh), HttpOnly + SameSite=Lax + Secure en prod.

Routes API auth impl√©ment√©es :

POST /api/auth/register

Cr√©ation user (table users), profil individuel ou pro, attribution de r√¥le par d√©faut (user_individual ou user_pro), insertion d‚Äôun token de v√©rification email (table email_verification_tokens).

Envoi d‚Äôun email de v√©rif via Brevo (SMTP) avec lien /verify-email?token=...

Validation de base c√¥t√© serveur : email, mot de passe, ville, type de compte, champs sp√©cifiques individual/pro.

POST /api/auth/login

R√©cup√©ration de l‚Äôutilisateur par email avec ses r√¥les (JOIN user_roles/roles).

V√©rification du statut (pending_email_verification, suspended, etc.).

V√©rification du mot de passe avec bcrypt.

G√©n√©ration d‚Äôun access token et d‚Äôun refresh token (JWT).

Insertion du refresh token en base (table refresh_tokens).

Pose des cookies HttpOnly.

Retour d‚Äôun objet user ‚Äúsafe‚Äù pour le front.

POST /api/auth/logout

Lecture du refresh token depuis le cookie.

R√©vocation du refresh token en DB (revoked_at = NOW()).

Nettoyage syst√©matique des cookies d‚Äôauth.

POST /api/auth/forgot-password

Input : email.

Si l‚Äôutilisateur existe : cr√©ation d‚Äôun token dans password_reset_tokens avec TTL d‚Äô1h + envoi d‚Äôun email avec lien /reset-password?token=...

R√©ponse toujours neutre (‚ÄúSi un compte existe avec cet email‚Ä¶‚Äù) pour ne pas exposer si l‚Äôemail est connu ou non.

POST /api/auth/reset-password

Input : token + newPassword.

V√©rification du token en DB (existe, pas expir√©, pas d√©j√† utilis√©, user non suspendu).

Hash du nouveau mot de passe et mise √† jour dans la table users.

Marquage du token comme utilis√©.

R√©vocation de tous les refresh tokens pour ce user.

Nettoyage des cookies d‚Äôauth.

GET /api/auth/me

Retourne la session courante (userId, email, accountType, roles, city, country, locale) ou null.

Email utilitaire : server/utils/email.js

Mise en place de l‚Äôenvoi d‚Äôemails via Nodemailer + SMTP Brevo (host, port, user, pass).

Fonctions :

sendEmail

sendEmailVerification (lien verify-email)

sendPasswordResetEmail (lien reset-password)

Backend ‚Äì Session & middleware

Utilitaire server/utils/authSession.js

getAuthSession(event) :

Lit les cookies access/refresh.

Valide l‚Äôaccess token ‚Üí construit une session minimale √† partir du payload JWT.

Si access invalide mais refresh valide : v√©rifie le refresh JWT + la pr√©sence du token en DB (non r√©voqu√©, non expir√©), recharge l‚Äôutilisateur depuis la DB, r√©g√©n√®re un nouveau pair access/refresh, fait la rotation en DB et met √† jour les cookies.

Hydrate event.context.auth (null ou objet session).

requireAuth(event, options) :

V√©rifie qu‚Äôune session est pr√©sente, sinon 401.

Peut v√©rifier des r√¥les (ex : roles: ['admin']) et renvoyer 403 si absent.

Middleware global : server/middleware/auth.global.js

Appelle getAuthSession(event) sur chaque requ√™te pour avoir event.context.auth dispo partout (API, SSR).

Front ‚Äì Store & composables

Store Pinia : stores/auth.js

state : user, loading, error, initialized.

getters : isAuthenticated, roles, isAdmin, isPro.

actions :

login({ email, password }) ‚Üí POST /api/auth/login, met √† jour user.

logout() ‚Üí POST /api/auth/logout, nettoie le state.

fetchMe() ‚Üí GET /api/auth/me, hydrate user.

ensureAuthLoaded() pour √©viter de re-fetch plusieurs fois.

Composable useAuth : composables/useAuth.js

Wrap du store auth pour exposer : user, isAuthenticated, roles, isAdmin, isPro, loading, error.

Hydratation automatique via /api/auth/me c√¥t√© serveur (onServerPrefetch) et c√¥t√© client (onMounted), sauf si fetchUser: false.

Design system global (CSS)

Fichier assets/css/main.css cr√©√© comme ‚Äúdesign system Matanga‚Äù :

Variables CSS pour :

couleurs (bg, surface, text-main, text-muted, accent, etc.),

th√®me clair et th√®me sombre (via :root),

typographie (font-body, font-title),

rayons, ombres, espacements, transitions, largeurs.

Styles globaux : body, titres, paragraphes, liens.

Layout : app-shell, app-header, app-main, container, container-narrow, section, grid responsive (grid-2-cols, grid-3-cols).

Composants :

.card (+ variantes elevated, muted, header/body/footer)

Formulaires (.form, .form-field, .form-control, labels, erreurs, hints, textarea, select)

Boutons (.btn, .btn-primary, .btn-secondary, .btn-accent, .btn-ghost, .btn-danger, tailles sm/lg)

Chips & badges (.chip, .chip-accent, .badge-success, .badge-danger, etc.)

Tables (.table-wrapper, .table, styles pour th/td, hover).

Utilitaires : marges (mt-, mb-), paddings, flex (flex, flex-col, flex-row, items-center, justify-between), gap-*.

Animation l√©g√®re .fade-in pour apparitions douces.

Skip-link .skip-link pour accessibilit√© (visible au focus).

Th√®me clair/sombre ‚Äì useTheme + layout

Composable useTheme :

Stocke le th√®me dans useState('matanga-theme').

Applique data-theme="light|dark" sur document.documentElement.

Persistance en localStorage.

Prend en compte prefers-color-scheme si aucune pr√©f√©rence stock√©e.

Layout par d√©faut : layouts/default.vue

Layout global Matanga : header sticky avec logo, tagline et bouton de switch th√®me.

Bouton accessible : aria-pressed, aria-label dynamique.

Skip-link ‚ÄúPasser au contenu principal‚Äù.

main avec id="main-content" et role="main".

app.vue

Contient <NuxtLayout><NuxtPage/></NuxtLayout.

D√©finit le titre global via useHead avec titleTemplate.

Initialise useTheme pour s‚Äôassurer que le th√®me est appliqu√© d√®s le d√©part.

Pages front cr√©√©es

Home : pages/index.vue

Landing page structur√©e en sections :

Hero : titre principal, description, CTA ‚ÄúCr√©er un compte gratuitement‚Äù, ‚ÄúSe connecter‚Äù.

Section ‚ÄúPour qui est fait Matanga ?‚Äù (familles / pros).

Section ‚ÄúComment fonctionne Matanga ?‚Äù (3 √©tapes).

CTA final avec mise en avant des cas d‚Äôusage (Brazzaville, Kinshasa, Abidjan, Paris, etc.).

SEO : useSeoMeta avec title, description, ogTitle, ogDescription, ogType, ogUrl, twitterCard.

Accessibilit√© : sections avec aria-labelledby reli√©es √† leurs h1/h2 (ids d√©di√©s).

Register : pages/register/index.vue

Formulaire complet de cr√©ation de compte :

Switch type de compte : particulier / professionnel.

Champs communs : email, mot de passe, confirmation, ville, pays, t√©l√©phone, langue pr√©f√©r√©e.

Champs particuliers : pr√©nom, nom.

Champs pros : nom de la structure, type de structure (pompes fun√®bres, √©glise, mosqu√©e, association, autre), adresse, site web.

Validation c√¥t√© client (email, mot de passe, confirmPassword, champs obligatoires selon type).

Appel API POST /api/auth/register avec payload adapt√©.

Gestion des messages de succ√®s (v√©rifier l‚Äôemail) et des erreurs.

Redirection vers ‚Äú/‚Äù si l‚Äôutilisateur est d√©j√† connect√©.

Login : pages/login/index.vue

Formulaire de connexion email + mot de passe.

Validation simple c√¥t√© client.

Appel auth.login ‚Üí /api/auth/login via le store.

Support d‚Äôun param√®tre ?redirect=/chemin dans l‚ÄôURL pour rediriger apr√®s login.

Liens vers ‚ÄúMot de passe oubli√©‚Äù et ‚ÄúCr√©er un compte‚Äù.

Redirection vers ‚Äú/‚Äù si d√©j√† connect√©.

Forgot password : pages/forgot-password/index.vue

Formulaire minimal : email.

Validation email c√¥t√© client.

Appel POST /api/auth/forgot-password.

Affichage d‚Äôun message neutre de succ√®s.

Accessibilit√© : aria-invalid, aria-describedby pour le champ email + role="status"/"alert" sur les messages.

Reset password : pages/reset-password/index.vue

Lecture du token dans la query (reset-password?token=...).

Si pas de token ‚Üí affichage d‚Äôun message explicite + lien vers forgot-password.

Formulaire : nouveau mot de passe + confirmation.

Validation c√¥t√© client (longueur, correspondance).

Appel POST /api/auth/reset-password avec token + newPassword.

Messages de succ√®s/erreur, possibilit√© de rediriger vers /login ensuite.

√âtat actuel

Authentification back + front : cycle complet en place (register, verify, login, logout, forgot, reset, me, session).

Design system global CSS : pr√™t, avec th√®mes clair/sombre, layout, composants, utilitaires.

Pages publiques essentielles : home, register, login, forgot-password, reset-password.

Accessibilit√© : header avec skip-link, r√¥les ARIA principaux, formulaires d√©j√† partiellement accessibles.

Prochaines √©tapes envisag√©es

Compl√©ter l‚Äôaccessibilit√© sur toutes les pages (aria-invalid syst√©matique, aria-describedby pour chaque message d‚Äôerreur).

Commencer la mod√©lisation m√©tier : tables annonces n√©crologiques, dur√©es de publication, options (anniversaire, prolongation), tarifs, promotions, villes/pays, notifications.

APIs CRUD pour les annonces, avec filtrage par pays/ville, visibilit√© publique, statut (brouillon, publi√©, expir√©).

Gestion des r√¥les avanc√©s : moderator/admin pour validation d‚Äôannonces, mod√©ration, signalements.

SEO encore plus pouss√© : sitemap, balisage schema.org (event/obituary), meta langue, etc. 

////
1. Journal de dev ‚Äì Matanga (session du jour)
1) Contexte g√©n√©ral

Projet : Matanga ‚Äì plateforme d‚Äôannonces n√©crologiques & veill√©es pour Afrique / diaspora / Cara√Øbes, mobile-first, premium, SEO fort, multi-langues.

Stack :

Nuxt 4 (SSR), JavaScript only.

MySQL comme base principale.

Auth JWT c√¥t√© backend, cookies HttpOnly/Secure (d√©j√† pos√© conceptuellement).

Brevo (Sendinblue) pour l‚Äôemail (SMTP).

2) Backend ‚Äì Authentification & emails

Variables d‚Äôenvironnement

Mise en place (ou rappel) des variables .env pour l‚Äôemail & URLs :

SMTP_HOST=smtp-relay.brevo.com

SMTP_PORT=587

SMTP_USER=‚Ä¶

SMTP_PASS=‚Ä¶

EMAIL_FROM=‚Ä¶

APP_URL=https://www.matanga.net

BASE_URL=https://www.matanga.net (ou http://localhost:3000 en dev)

Utilitaires backend

server/utils/db.js

Client MySQL solide avec :

gestion de pool,

fonction query() avec options (ex: requestId) pour logging,

fonction transaction() avec gestion commit/rollback et logs.

server/utils/logger.js

Fonctions logInfo et logError structur√©es (message + meta : email, requestId‚Ä¶).

server/utils/email.js

Envoi d‚Äôemails via SMTP Brevo :

sendEmailVerification({ toEmail, toName, token })

sendPasswordResetEmail({ toEmail, toName, token })

Construction des liens √† partir de APP_URL (ex : /verify-email?token=..., /reset-password?token=...).

Routes API d‚Äôauth

server/api/auth/register.post.js

Inscription avec :

email, password, accountType (individual | pro),

city, country, preferredLocale,

profil particulier : firstName, lastName, phone,

profil pro : organizationName, organizationType, address, phone, websiteUrl.

Validations :

email valide,

mot de passe ‚â• 8 caract√®res,

ville obligatoire,

champs sp√©cifiques selon accountType.

Logique :

v√©rif email unique,

hash password (bcrypt),

cr√©ation user (status = pending_email_verification),

cr√©ation profil individuel ou pro dans les tables sp√©cialis√©es,

affectation r√¥le (user_individual ou user_pro) via user_roles,

g√©n√©ration token de v√©rif email (TTL 24h) dans email_verification_tokens,

envoi email de v√©rification.

server/api/auth/login.post.js (on l‚Äôa d√©j√† pos√© plus t√¥t dans la journ√©e)

Authentification par email/password,

v√©rification status user (active, pending_email_verification, etc.),

cr√©ation du JWT + refresh token,

√©criture des cookies HttpOnly/Secure c√¥t√© SSR.

server/api/auth/logout.post.js

Suppression / invalidation des cookies d‚Äôauth (clear token c√¥t√© client).

server/api/auth/forgot-password.post.js

G√©n√©ration d‚Äôun token de reset dans une table d√©di√©e (ex: password_reset_tokens),

envoi d‚Äôun email avec lien de reset.

server/api/auth/reset-password.post.js

V√©rification du token,

mise √† jour du password_hash,

invalidation du token.

server/api/auth/verify-email.get.js

V√©rification du token d‚Äôemail,

mise √† jour du status user -> active,

clean des tokens utilis√©s/expir√©s.

server/api/auth/resend-verification.post.js

Re√ßois un email,

si user existe et n‚Äôest pas v√©rifi√© :

r√©g√©n√®re un token,

renvoie un email de v√©rification,

renvoie un message ‚Äúsi un compte existe‚Ä¶‚Äù pour ne pas leak l‚Äôexistence d‚Äôun compte.

3) Front ‚Äì Auth / stores / composables

Store d‚Äôauth & composable

stores/auth.js (Pinia)

State : user, isAuthenticated, pending, error.

Actions :

login(credentials),

logout(),

fetchMe() / fetchUser(),

gestion des erreurs globales.

composables/useAuth.js

Wrapper pour centraliser la logique dans les pages :

retour de isAuthenticated, user, login(), logout(), fetchUser().

option fetchUser: true pour pr√©charger l‚Äôutilisateur quand n√©cessaire.

4) Front ‚Äì Th√®me, layout, styles globaux

Th√®me (clair/sombre)

composables/useTheme.js

Gestion du th√®me :

theme = 'light' | 'dark',

toggleTheme(),

lecture/√©criture dans localStorage,

synchronisation avec <html data-theme="light|dark"> pour tout le CSS.

layouts/default.vue

Layout g√©n√©ral avec :

structure ‚Äúshell‚Äù :

header avec logo ‚ÄúMatanga ‚Äì Annonces & veill√©es`,

skip-link pour accessibilit√©,

bouton toggle th√®me (clair/sombre) accessible (aria-pressed, aria-label),

zone nav (future : login / profil),

<main id="main-content"><NuxtPage /></main>.

Mobile-first, centr√© sur un contenu clean pour l‚Äôinstant.

Styles globaux

Mise en place d‚Äôun socle de classes CSS (dans un global CSS ou dans app.vue) :

Layout :

.page-centered, .container-narrow, .app-shell, .app-header, .app-main‚Ä¶

Cards :

.card, .card-elevated, .card-header.

Typo :

.text-muted, .text-soft, .text-xs, .text-sm‚Ä¶

Boutons :

.btn, .btn-primary, .btn-secondary, .btn-ghost, .btn-sm.

Formulaires :

.form, .form-field, .form-label, .form-control, .form-error, .form-error-input, .form-hint, .form-row, .form-row-inline.

Chips / badges :

.chip, .chip-accent, .badge-danger.

Animations simples :

.fade-in pour l‚Äôapparition des cartes.

C‚Äôest la base d‚Äôun design syst√®me premium Matanga, √† raffiner plus tard.

5) i18n ‚Äì Multi-langues

Module Nuxt i18n

Installation de @nuxtjs/i18n.

Config dans nuxt.config.js :

modules: ['@nuxtjs/i18n', ...]

i18n :

locales: fr, en, pt, es (fichiers JSON),

defaultLocale: 'fr',

strategy: 'prefix_except_default' ( / = FR, /en, /pt, /es pour le reste),

lazy: true,

langDir: 'locales',

vueI18n: './i18n.config.js' (chemin vers la config vue-i18n).

Config vue-i18n

Fichier i18n.config.js √† la racine :

export default defineI18nConfig(() => ({
  legacy: false,
  locale: 'fr',
  fallbackLocale: 'fr',
  availableLocales: ['fr', 'en', 'pt', 'es']
}));


Fichiers de langues

Dossier locales/ avec au moins :

locales/fr.json :

D√©finit toutes les cl√©s utilis√©es pour la page register :

auth.register.title, subtitle,

account_type.*,

fields.*, placeholders.*, actions.*,

errors.*, hints.*,

bloc resend pour renvoi email v√©rification.

en.json, pt.json, es.json √† faire plus tard (copie/traduction de fr.json).

6) Page Register ‚Äì UX premium + i18n

pages/register/index.vue r√©√©crite :

Utilise useI18n() ‚Üí t('auth.register.‚Ä¶') pour tous les textes.

Champs :

email, password, confirmPassword,

city, country, preferredLocale,

champs individuels : firstName, lastName, phone,

champs pro : organizationName, organizationType, address, phone, websiteUrl.

Switch type de compte (individual / pro) avec deux boutons styl√©s.

Validation c√¥t√© front :

email valide,

mot de passe min 8,

confirmation identique,

ville obligatoire,

champs sp√©cifiques par type.

Gestion erreurs :

fieldErrors par champ,

globalError pour message global.

Boutons voir/cacher mot de passe + confirmation :

showPassword, showConfirmPassword.

Int√©gration renvoi email de confirmation :

bouton qui appelle /api/auth/resend-verification avec l‚Äôemail saisi,

resendLoading, resendMessage, resendError + textes i18n.

Redirection si d√©j√† connect√© :

useAuth(fetchUser: true),

si isAuthenticated ‚Üí router.push('/').

7) Donn√©es de test ‚Äì N√©crologies & √©v√©nements

Tables d√©j√† en place

users, user_roles

obituaries

obituary_events

obituary_media

obituary_contacts

Jeu de donn√©es ins√©r√© aujourd‚Äôhui (pour user_id = 1) :

Annonce 1 ‚Äì Maman Marie NDINGA (Congo, Brazzaville ‚Üî Paris)

obituaries :

slug = 'maman-marie-ndinga-2025-brazzaville'

ville principale : Brazzaville (CG), annonce de d√©c√®s.

obituary_events :

veill√©e principale √† Brazzaville (domicile),

veill√©e secondaire √† Paris (salle paroissiale + stream YouTube Live),

obs√®ques + inhumation au village (Congo, r√©gion Plateaux).

obituary_media :

portrait principal (image),

photos symboliques veill√©e Brazzaville / Paris,

vid√©o YouTube (replay live Paris).

obituary_contacts :

contact famille Congo,

contact famille France.

Annonce 2 ‚Äì Monsieur KOUADIO Koffi (C√¥te d‚ÄôIvoire, Abidjan ‚Üî Paris)

slug = 'monsieur-kouadio-koffi-2025-abidjan'

payant (premium_30d), mobile money (CI).

√âv√©nements :

veill√©e principale √† Abidjan,

veill√©e diaspora √† Paris (Zoom),

obs√®ques + inhumation √† Abidjan (cimeti√®re de Williamsville).

M√©dias :

visuel portrait + image veill√©e Abidjan.

Contacts :

contact CI,

contact diaspora France.

Annonce 3 ‚Äì Gran M√® Rose DESIR (Martinique ‚Üî Montr√©al, messe de 40 jours)

slug = 'gran-me-rose-desir-2025-martinique'

√âv√©nements :

veill√©e √† Fort-de-France (tradition antillaise),

veill√©e diaspora √† Montr√©al (Facebook Live),

‚Äúmesse de 40 jours‚Äù mod√©lis√©e comme event_type = 'funeral' avec un titre sp√©cifique.

M√©dias :

visuel principal,

images symboliques pour veill√©es Martinique et Montr√©al.

Contacts :

famille en Martinique,

contact diaspora au Canada.

Ces donn√©es vont servir √† tester :

listing d‚Äôannonces,

filtrage par ville/pays,

affichage d√©taill√© d‚Äôune annonce (timeline d‚Äô√©v√©nements, m√©dias, contacts),

SEO (title, description par annonce).
2025-12-03 ‚Äì Donn√©es de test n√©crologies (suite)

Ajout de 3 nouvelles annonces de test (MUKENDI ‚Äì Kinshasa/Johannesburg, DIALLO ‚Äì Conakry/Lyon, MBOUMA ‚Äì Libreville/Paris).

Variation des cas d‚Äôusage :

multi-veill√©es avec live Zoom,

pri√®re √† la mosqu√©e + inhumation au village,

cas simple avec veill√©e unique + messe souvenir √† 40 jours.

Objectif : tester la page de d√©tail n√©crologique (timeline d‚Äô√©v√©nements, affichage des contacts, supports m√©dias) et, plus tard, le listing/filtrage par ville/pays.

Yes, faisons un vrai checkpoint Matanga üëá

1. Backend & donn√©es ‚Äî o√π on en est
1.1 Tables principales (DB)

users / user_individual_profiles / user_pro_profiles

Users : email, account_type (individual/pro), statut, ville, pays, locale.

Individual : first_name, last_name, phone.

Pro : organization_name, type (funeral_home, church‚Ä¶), adresse, website, etc.

obituaries

Tout le c≈ìur de l‚Äôannonce : nom du d√©funt, dates, religion, texte, slug, status, visibility, pays/ville, mon√©tisation (is_free, pricing_tier, currency, amount_paid, publish_duration_days, expires_at, etc.), cover_image_url, stats (view_count‚Ä¶).

obituary_events

Timeline : veill√©e, messe, inhumation, m√©morial‚Ä¶ avec starts_at, venue_name, address, ville/pays, online flags, etc.

obituary_contacts

Contacts publics de la famille (t√©l√©phone, WhatsApp, email) pour info/condol√©ances.

obituary_media

Images / vid√©os li√©es √† l‚Äôannonce (type, provider, url, thumbnail, is_main, sort_order).

Rien n‚Äôa √©t√© cass√© dans le sch√©ma DB, on s‚Äôappuie dessus.

1.2 API annonces
GET /api/obituaries (listing)

Filtres :

page, pageSize

country_code, city, language, type (death/anniversary/memorial/other)

is_free, sort (recent / oldest / popular)

q pour recherche (nom du d√©funt / titre)

Ne renvoie que :

status = 'published'

visibility = 'public'

moderation_status != 'removed'

fen√™tre de publication (publish_at <= NOW, expires_at > NOW ou NULL)

Inclus dans chaque item :

m√©tadonn√©es de l‚Äôannonce

coverImageUrl (donc les miniatures sont dispo)

mainEvent (√©v√©nement principal calcul√© comme le plus t√¥t dans obituary_events).

GET /api/obituary/[slug]

Charge une annonce compl√®te + :

events[] (tous les √©v√©nements li√©s, ordonn√©s)

contacts[] (contacts publics, primaires d‚Äôabord)

R√®gles d‚Äôacc√®s :

Public : seulement si published, pas removed, pas private.

Propri√©taire / admin / mod√©rateur : peuvent voir brouillons, priv√©s, etc.

Incr√©mente view_count + last_view_at pour les annonces publi√©es.

POST /api/obituaries

On l‚Äôa align√© sur ton create form :

champs d√©funt (identityStatus, gender, dates, ageDisplay, religion, denomination‚Ä¶)

localisation

contenu (title, body, mainLanguage)

mon√©tisation (isFree, pricingTier, publishDurationDays, etc.)

√©v√©nements (table obituary_events)

contacts (table obituary_contacts)

coverImageUrl

Actuellement, c√¥t√© front on envoie un seul √©v√©nement principal et z√©ro ou un contact.

2. Frontend ‚Äî pages & UX
2.1 App & layout

App.vue

Th√®me clair/sombre g√©r√© via useTheme.

SEO global (OpenGraph, JSON-LD organization, meta description, canonical, etc.).

layouts/default.vue

Header pro Matanga (logo + tagline).

Bouton th√®me avec ic√¥ne soleil/lune + libell√© ‚ÄúTh√®me clair / sombre‚Äù.

Bandeau utilisateur sous le header :

utilise UserInlineCard + authStore

affiche l‚Äô√©tat du compte, nom / orga quand connect√©.

2.2 Bandeau utilisateur (UserInlineCard.vue)

En invit√© :

texte du type :

Visiteur ‚Äì vous n‚Äô√™tes pas encore connect√©
‚ÄúConnectez-vous ou cr√©ez un compte pour publier et g√©rer vos annonces.‚Äù

boutons :

Se connecter ‚Üí /login

Cr√©er un compte ‚Üí /register

En connect√© :

affiche :

displayName (pr√©nom + nom pour particulier, organization_name pour pro)

ou fallback email

montre le r√¥le :

‚ÄúCompte particulier‚Äù / ‚ÄúCompte professionnel‚Äù / ‚ÄúCompte Matanga‚Äù

boutons :

Mon espace ‚Üí /dashboard (route √† d√©finir)

Se d√©connecter (appel authStore.logout(), redirection /).

Design :

fond coh√©rent avec les variables th√®me (var(--color-surface-muted)),

pas de gros fond noir en clair.

2.3 Home / listing

Nouvelle page d‚Äôaccueil :

Hero pro (titre, sous-titre, body, CTA cr√©a + CTA recherche) avec cl√©s i18n home.hero.*.

Section ‚ÄúComment √ßa marche‚Äù (3 √©tapes).

Bloc ‚ÄúAnnonces r√©centes‚Äù :

cartes avec :

miniature (coverImageUrl)

type d‚Äôannonce / titre

date de d√©c√®s + √¢ge + ‚Äúil y a X heures/jours‚Äù gr√¢ce √† useDateUtils

ville / r√©gion / pays

badge Gratuit / Payant selon isFree et pricingTier

√©vent principal (date/lieu) si dispo

compteur vues.

Zone de recherche / filtres :

pays, ville, texte libre, tri.

Utilisation de ton composant Pagination.vue adapt√© (labels i18n, r√©sum√©, goto page).

2.4 Page d√©tail annonce /obituary/[slug]

On a con√ßu une page ‚Äúhaut de gamme‚Äù :

en-t√™te avec :

type d‚Äôannonce, nom complet, √¢ge affich√©, dates naissance/d√©c√®s si pr√©sentes.

badge plan (Gratuit / Essentiel / etc. selon pricing_tier).

localisation principale.

Photo principale :

coverImageUrl si pr√©sent, sinon avatar symbolique.

Corps de texte de l‚Äôannonce (body, paragraphe lisible, responsive).

Timeline des √©v√©nements (wake, messe, enterrement, m√©morial) :

pour chaque event : date/heure (via useDateUtils), type d‚Äô√©v√©nement, lieu, adresse, ville/pays.

Contacts :

liste des contacts publics (nom, label, tel, WhatsApp, email), format√©s proprement.

Accessibilit√© :

niveaux de titres <h1> / <h2>, aria-labels, structure claire mobile-first.

(M√™me si tu ne m‚Äôas pas recoll√© le fichier l√† maintenant, le design qu‚Äôon a d√©crit repose bien sur l‚ÄôAPI que tu as montr√©e.)

2.5 Page cr√©ation /obituary/create

Formulaire multi-blocs, mobile-first :

Infos d√©funt

nom complet

genre (H/F)

niveau d‚Äôidentification (known / partial / unknown)

dates naissance / d√©c√®s

√¢ge affich√©

religion + d√©nomination

localisation (ville, r√©gion, pays, code pays, rural ou non).

Texte de l‚Äôannonce

titre (auto-sugg√©r√© √† partir du nom : ‚ÄúAnnonce de d√©c√®s ‚Äì {name}‚Äù)

texte (body) avec validation longueur min.

√âv√©nement principal

type (veill√©e, obs√®ques, inhumation, m√©morial)

date/heure (datetime-local ‚Üí normalis√© en YYYY-MM-DD HH:mm:ss)

lieu + adresse.

Contact famille

nom, t√©l√©phone, WhatsApp, email

cr√©√© en m√™me temps dans obituary_contacts si renseign√©.

Photo & publication (gratuit)

URL de la photo principale (coverImageUrl)

texte l√©gal / consentement.

Validation c√¥t√© front :

nom d√©funt obligatoire

titre obligatoire

texte min 40 caract√®res

date/heure event obligatoire.

Payload :

aligne les noms de champs avec index.post.js (API create),

envoie events[] et contacts[],

mon√©tisation actuellement fix√©e √† :

isFree: true

pricingTier: 'free_basic'

publishDurationDays: 5 (constante FREE_PLAN_DURATION_DAYS).

3. Auth / session ‚Äî √©tat actuel

JWT access + refresh, cookies HttpOnly via authCookies.

/api/auth/login :

v√©rifie l‚Äôemail + mot de passe,

v√©rifie status (pending, suspended‚Ä¶),

charge les r√¥les (user_roles),

signe access + refresh tokens, enregistre le refresh en DB.

utils/authSession.js :

lit cookies access / refresh,

v√©rifie access token :

maintenant, recharge l‚Äôutilisateur depuis la DB via buildSessionFromUserId :

users + user_individual_profiles + user_pro_profiles + roles.

construit une session enrichie :

userId, email, accountType, roles, city, country, locale

firstName, lastName, organizationName, displayName.

si access expir√© : utilise le refresh pour √©mettre un nouveau access + aller en DB.

/api/auth/me :

renvoie { ok: true, user: session }
‚Üí le front r√©cup√®re bien displayName.

Store Pinia auth :

user, isAuthenticated, roles, isAdmin, isPro, loading, error.

ensureAuthLoaded() appelle /api/auth/me une seule fois.

login() : appelle /api/auth/login puis fetchMe() pour hydrater complet.

logout() : appelle /api/auth/logout (ou √©quivalent) et reset le store.

useAuth() :

composable qui connecte les pages au store (user, isAuthenticated, etc.), avec hydratation automatique SSR/CSR.

4. Plans & mon√©tisation ‚Äî ce qui est d√©cid√© / ce qui reste √† fixer

On a pas encore tout cod√©, mais on a converg√© sur plusieurs principes fonctionnels :

4.1 Ce qui est d√©j√† en dur dans le code

Plan par d√©faut √† la cr√©ation via la page actuelle :

Plan ‚ÄúGratuit basique‚Äù :

is_free = 1

pricing_tier = 'free_basic'

publish_duration_days = 5 (techniquement, on pourra passer √† 7 ou 10 en ajustant la constante).

1 √©v√©nement principal

1 contact (facultatif)

1 cover_image_url

pas de streaming / online pour le free (le champ stream_url ne sera pas expos√© c√¥t√© form pour free).

Apr√®s expiration, on a pr√©vu : archiver l‚Äôannonce (pas encore impl√©ment√©, mais pens√© pour).

4.2 Plans discut√©s pour particuliers (non cod√©s mais ‚Äúdesign√©s‚Äù)

(Ce sont des specs produit, pas encore impl√©ment√©es dans le front ni dans la logique d‚Äôupgrade)

Free basic

Dur√©e : 5‚Äì7 jours (√† trancher exactement; le code est √† 5, toi tu penches plut√¥t pour 7 ou 10 max).

Limitations :

1 √©v√©nement

1 contact

1 photo (cover)

pas de lien online.

Apr√®s expiration :

soit archivage,

soit mont√©e de plan payant.

Prolongation du free (Pack simple / add-on)
On a beaucoup it√©r√©, mais le dernier consensus √©tait :

Free de base ‚Üí possibilit√© de prolonger la visibilit√© √† 20 jours (10 ‚Üí 20) via un add-on ‚âà 12 ‚Ç¨ (tu as parl√© ensuite de 15 ‚Ç¨, √† repr√©ciser).

Pas de prolongation gratuite infinie :

max ~10 jours gratuits,

au-del√† : payant.

Toujours avec les m√™mes limites (1 event, 1 contact, 1 photo).

Pack Essentiel (payant)

Tu as valid√© le principe :

~30 jours de mise en avant principale,

+15 jours dans des zones secondaires (ex : ‚Äúautres annonces‚Äù).

Pricing :

on est parti sur 15 ‚Ç¨,

tu as remont√© √† 18 ‚Ç¨ pour garder un positionnement ‚Äúpremium‚Äù par rapport √† la simple prolongation.

Limites techniques (√† pr√©ciser mais id√©e g√©n√©rale) :

plus de photos (ex: 5 au lieu de 1)

1 vid√©o & lien replay

plus d‚Äô√©v√©nements

plus de contacts.

Plans m√©moriels (‚Äúpage m√©moire‚Äù)

Dur√©es plus longues :

6 mois, 1 an,

10 ans renouvelables plut√¥t que ‚Äú√† vie‚Äù.

Options :

page m√©morielle d√©di√©e,

bougies virtuelles, fleurs, messages,

commentaires authentifi√©s,

anniversaires automatiques (rappels chaque ann√©e).

Option priv√©e :

page m√©morielle consultable uniquement via un lien priv√© (non index√©e, pas list√©e).

Prix √©voqu√©s : ‚Äú20‚Äì40 ‚Ç¨ pour 6 mois, 30‚Äì50 ‚Ç¨ pour 1 an‚Äù, √† affiner.

4.3 Plans pro & abonnements

Pour les pros (pompes fun√®bres, √©glises, associations) :

au choix :

paiement √† l‚Äôannonce (comme un particulier mais avec quelques bonus),

ou abonnement mensuel avec quotas :

nombre d‚Äôannonces / mois,

nombre de mises en avant,

nombre de photos/vid√©os par annonce,

anniversaires inclus,

support prioritaire, etc.

Rien n‚Äôest encore cod√© c√¥t√© plans pro, mais la DB est pr√™te :

account_type = 'pro'

user_pro_profiles

et dans obituaries : user_id, pricing_tier, etc., permettent d√©j√† de distinguer.

4.4 Techniquement, c√¥t√© code ‚Äúplans‚Äù

On a pos√© les bases :

champs dans obituaries : is_free, pricing_tier, publish_duration_days, expires_at, etc.

la route GET /api/plans (que tu as commenc√©e) peut servir de source de v√©rit√© pour le front.

Ce qui reste √† faire (gros morceau √† venir) :

Une page /plans ou un s√©lecteur de plan avant / dans le formulaire create.

Adapter le formulaire /obituary/create en fonction du plan choisi :

nombre d‚Äô√©v√©nements autoris√©s,

nombre de photos / vid√©os,

options m√©morielles, etc.

Une √©tape de r√©cap :

/obituary/create/review ou step 2 sur la m√™me page.

Une page de paiement pour les plans payants (Stripe, PayPal, virement‚Ä¶).

Gestion des upgrades :

de free ‚Üí extension,

de simple ‚Üí Essentiel,

etc.

5. En r√©sum√© ultra-court

Tu as :

un backend solide (tables, APIs listing/d√©tail/cr√©ation),

une page d‚Äôaccueil pro avec liste d‚Äôannonces, miniatures, recherche, pagination,

une page de d√©tail coh√©rente avec les events/contacts,

une page de cr√©ation d√©j√† bien riche (d√©funt + event + contact + photo),

un syst√®me auth/session propre (JWT + refresh + profils + displayName),

un bandeau utilisateur qui g√®re invit√©/particulier/pro proprement.

Sur les plans, on a :

un plan gratuit d√©j√† c√¢bl√© (free_basic),

une vision claire des futurs plans (extension, Essentiel, m√©moriel, pro) et des r√®gles produit,

mais pas encore :

la page /plans,

la logique de choix de plan dans le formulaire,

ni l‚Äô√©tape paiement/upgrade.