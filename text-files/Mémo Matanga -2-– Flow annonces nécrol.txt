MÃ©mo Matanga â€“ Flow annonces nÃ©crologiques (Ã  rappeler dans le prochain chat)
1. Contexte gÃ©nÃ©ral

Stack : Nuxt 4 (SSR), JS only, dÃ©ployÃ© sur Vercel.

Auth : JWT + /api/auth/me, middleware auth cÃ´tÃ© Nuxt, auth.global cÃ´tÃ© server.

Domain : annonces nÃ©crologiques â€œparticuliersâ€.

Flow concernÃ© :

Choix dâ€™un plan sur /plans (ex. indiv_essentiel_30).

Formulaire de crÃ©ation : /obituary/create?plan=...

RÃ©cap / confirmation : /obituary/confirm/[slug]

Plus tard : publication / paiement (Ã  brancher).

Les annonces sont crÃ©Ã©es via POST /api/obituaries, qui renvoie un slug utilisÃ© sur la page de confirmation.

2. Fichiers clÃ©s Ã  revoir (sans toucher tant quâ€™on nâ€™a pas relu la version partagÃ©e)

app/pages/obituary/create/index.vue

app/pages/obituary/confirm/[slug].vue

Ã‰ventuellement : server/utils/pricingPlans.js (pour vÃ©rifier la cohÃ©rence des plans, sans modifier le back si possible).

RÃ¨gle importante pour la suite :
ğŸ‘‰ On ne modifie jamais un fichier sans avoir relu la version EXACTE que tu viens de coller dans le nouveau chat.

3. Ã‰tat actuel (ce quâ€™on a dÃ©jÃ  fait)
3.1. Sur /obituary/create

Lecteur de plan via route.query.plan avec fallback indiv_free_7.

PLAN_META cÃ´tÃ© front pour les plans individuels par annonce (scope â€œobituaryâ€) :

indiv_free_7

indiv_basic_21

indiv_essentiel_30

indiv_prestige_60

Chaque plan contient :

pricingTier, isFree, publishDurationDays, currency, basePriceCents

labelKey: 'plans.codes.xxx'

features alignÃ© sur server/utils/pricingPlans.js (maxEvents, maxPhotos, maxVideos, maxContacts, etc.).

Bandeau plan en haut du formulaire (selected-plan-banner) :

Affiche nom du plan + prix + texte â€œPlan choisi : â€¦ (publication X jours)â€.

Style revu pour Ãªtre lisible en clair / sombre (fond soft + bordure accent).

Formulaire :

Bloc dÃ©funt : identitÃ©, dates, localisation, religon, ruralitÃ©.

Bloc texte : titre + corps (avec validation).

Bloc Ã©vÃ©nement principal : type, date/heure, lieu.

Affiche un hint dynamique : Jusquâ€™Ã  N Ã©vÃ©nements en fonction de currentPlanFeatures.maxEvents.

Bloc contact famille : 1 contact.

Bloc publication : coverImageUrl + texte lÃ©gal.

Construction du payload pour /api/obituaries avec :

champs dÃ©funt + texte + localisation,

events: [ { ... isMainEvent: true } ] (un seul event pour lâ€™instant),

contacts: [] ou [contact principal],

infos de plan (isFree, pricingTier, currency, amountPaid, publishDurationDays, planCode).

Sur succÃ¨s : redirection systÃ©matique vers /obituary/confirm/${slug}.

3.2. Sur /obituary/confirm/[slug]

useFetch('/api/obituaries/:slug') pour rÃ©cupÃ©rer lâ€™annonce, ses events et contacts.

Mini PLAN_META front (les mÃªmes codes) pour calculer :

planLabel (via i18n plans.codes.*),

planPrice (Gratuit / X â‚¬ TTC),

planMeta.publishDurationDays (fallback sur obituary.publishDurationDays).

Layout 2 colonnes :

Colonne gauche :

Infos dÃ©funt (nom, genre, identitÃ©, dates, Ã¢ge, religion, localisation, ruralitÃ©).

Texte dâ€™annonce.

Liste dâ€™Ã©vÃ©nements (type, badget â€œÃ‰vÃ©nement principalâ€, date/heure, lieu).

Liste de contacts (nom, badge â€œcontact principalâ€, tÃ©lÃ©phone, WhatsApp, email).

Colonne droite :

RÃ©cap plan (Formule, DurÃ©e, Montant).

Texte lÃ©gal Matanga.

Boutons :

â€œModifier lâ€™annonceâ€ âœ pour lâ€™instant renvoie vers /obituary/create?plan=...

â€œPublier gratuitementâ€ (si plan gratuit) ou â€œConfirmer et payerâ€ (si payant, flow encore TODO).

4. ProblÃ¨mes connus Ã  traiter dans la prochaine session
4.1. ProblÃ¨mes dâ€™affichage (UI / thÃ¨me clair)

Sur la page de confirmation, certains textes/badges sont :

Ã©crits en noir sur fond sombre en mode clair, donc invisibles :

Les petites phrases dâ€™aide sous les titres de sections (â€œRelisez le titreâ€¦â€, â€œVÃ©rifiez la dateâ€¦â€),

Certains badges / labels.

Point Ã  faire :
ğŸ‘‰ Revoir les classes CSS de ces sous-titres et badges dans confirm/[slug].vue (et Ã©ventuellement create/index.vue) pour :

utiliser var(--color-text-soft) / var(--color-text) plutÃ´t que du noir fixe,

vÃ©rifier le fond des cartes / banniÃ¨res.

4.2. Plan mal restituÃ© sur /obituary/confirm

MÃªme quand on a choisi un plan payant (ex. Pack Essentiel 30 jours + rappel), la colonne droite affiche parfois :

Formule : Non renseignÃ©e

Publication : 0 jours

Montant : Gratuit

Donc quelque chose cloche entre :

ce que create envoie (planCode, pricingTier, isFree, publishDurationDays, etc.),

ce que le backend stocke et renvoie dans /api/obituaries/:slug,

ce que confirm lit (planCodeFromData, currentPlanMeta, planLabel, planPrice).

Point Ã  faire :

VÃ©rifier dans la rÃ©ponse JSON dâ€™un exemple dâ€™annonce :

planCode

pricingTier

publishDurationDays

isFree

amountPaid

Sâ€™assurer que :

planCodeFromData lit les bons champs,

PLAN_META front contient bien le code utilisÃ© (indiv_essentiel_30, etc.),

la durÃ©e affichÃ©e utilise le bon fallback :

dâ€™abord currentPlanMeta.publishDurationDays

sinon obituary.publishDurationDays

sinon 0 (mais Ã§a doit rester un cas rare).

4.3. Formulaire create pas encore alignÃ© avec les features des plans

Aujourdâ€™hui, mÃªme pour Essentiel / Prestige, le formulaire :

ne permet quâ€™un seul Ã©vÃ©nement,

quâ€™un seul contact,

et une seule image (coverImageUrl).

Alors que les features des plans prÃ©voient :

Gratuit : 1 event / 1 photo / 1 contact

Essentiel : jusquâ€™Ã  3 events / 3 photos / 1 vidÃ©o / 2 contacts

Prestige : encore plus.

Point Ã  faire (gros morceau prÃ©vu) :

Transformer le bloc â€œÃ‰vÃ©nement principalâ€ en builder multi-Ã©vÃ©nements limitÃ© par currentPlanFeatures.maxEvents.

PrÃ©parer la structure pour plusieurs mÃ©dias (photos / vidÃ©os) mÃªme si on commence simple.

Permettre plusieurs contacts jusquâ€™Ã  currentPlanFeatures.maxContacts.

5. PrioritÃ©s pour la prochaine session (ordre proposÃ©)

Quand on relancera dans le nouveau chat avec ce mÃ©mo :

Relire la VERSION ACTUELLE de :

pages/obituary/create/index.vue

pages/obituary/confirm/[slug].vue
(tu les recolleras entiÃ¨rement pour Ãªtre sÃ»r quâ€™on travaille sur le bon code).

Corriger lâ€™affichage plan sur la page de confirmation :

Sâ€™assurer que Formule / DurÃ©e / Montant reflÃ¨tent vraiment le plan choisi.

Fixer les problÃ¨mes de contraste / couleurs :

Badges, sous-titres, messages dâ€™aide en mode clair.

Commencer le builder multi-Ã©vÃ©nements dans create/index.vue :

Introduire form.events[] au lieu de form.event unique,

UI minimaliste pour ajouter / supprimer jusquâ€™Ã  currentPlanFeatures.maxEvents,

Garder un event principal (isMainEvent ou le premier par dÃ©faut).