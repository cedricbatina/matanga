RÃ©cap clair de lâ€™Ã©tat du projet / ce qui reste Ã  faire

Un bloc de journal prÃªt Ã  coller dans â€œJournal de dev â€“ Matangaâ€

1ï¸âƒ£ OÃ¹ on en est vraiment (flow obituaries)
Flow actuel (particulier)

/plans â†’ choix dâ€™un plan
indiv_free_7, indiv_basic_21, indiv_essentiel_30, indiv_prestige_60

/obituary/create?plan=â€¦ â†’ crÃ©ation dâ€™annonce (brouillon en DB)

/obituary/confirm/[slug] â†’ rÃ©cap complet

plan / prix / durÃ©e

dÃ©funt, texte, Ã©vÃ©nements, contacts

NOUVEAU : section â€œDocuments justificatifsâ€ (CNI + certificat de dÃ©cÃ¨s)

actions :

plan gratuit â†’ publication directe via POST /api/obituaries/:slug/publish

plan payant â†’ redirection vers /checkout/obituary/[slug]

/checkout/obituary/[slug] â†’ choix du moyen de paiement

Stripe (CB)

PayPal

Virement bancaire (instructions)

Paiement :

Stripe â†’ /api/payments/checkout (provider stripe) â†’ redirige vers Stripe

PayPal â†’ idem avec provider paypal

Virement â†’ renvoie les instructions (IBAN, BIC, montant, rÃ©fÃ©rence)

Retour succÃ¨s :

Stripe â†’ /checkout/stripe-success?session_id=â€¦

GET /api/payments/stripe/confirm :

vÃ©rifie la session Stripe

met Ã  jour payment_transactions (status = 'succeeded', montants, ids Stripe)

met Ã  jour obituaries (payment_provider='stripe', amount_paid, currency)

la page /checkout/stripe-success affiche :

montant

annonce concernÃ©e

#payment_id interne

PayPal â†’ /checkout/paypal-success?...

handler de confirm + page de succÃ¨s dÃ©jÃ  crÃ©Ã©s, mais encore Ã  bien tester + traductions fr rajoutÃ©es (bloc checkoutPaypalSuccess).

ğŸ‘‰ Important :
Pour les plans payants, aprÃ¨s paiement, lâ€™annonce reste :

status = 'draft'

verification_status restant Ã  gÃ©rer (pour la modÃ©ration)

On a dÃ©cidÃ© que : rien ne doit se publier automatiquement â†’ il faudra une validation admin.

Documents justificatifs

Nouvelle table (conceptuellement) obituary_documents

id, obituary_id, user_id, type (id_card | death_certificate | other), file_url, status, admin_note, created_at, updated_at

contrainte UNIQUE (obituary_id, type)

Nouvelle section dans /obituary/confirm/[slug] :

bloc â€œPiÃ¨ce dâ€™identitÃ© du dÃ©clarantâ€

bloc â€œCertificat de dÃ©cÃ¨sâ€

upload par input type="file" + bouton de tÃ©lÃ©versement

le bouton â€œConfirmer et payerâ€ est dÃ©sactivÃ© tant que les deux docs ne sont pas envoyÃ©s

Nouveau handler :
POST /api/obituaries/[slug]/documents

requireAuth

vÃ©rifie que session.userId === obituaries.user_id (sauf admin/moderator)

lit le multipart/form-data

contrÃ´le size / type fichier (â‰¤10 Mo, image ou PDF)

upload dans Swiss Backup via S3 (appareil madizi-docs)

enregistre lâ€™URL (type s3://madizi-docs/obituary-documents/...)

upsert dans obituary_documents

renvoie la liste Ã  jour des documents

Infra :

Swiss Backup (Sauvegarde Cloud) configurÃ©

Appareil S3 madizi-docs crÃ©Ã©

ClÃ©s S3 (Access + Secret) rÃ©cupÃ©rÃ©es

Variables dâ€™environnement prÃ©vues :
S3_ENDPOINT, S3_ACCESS_KEY, S3_SECRET_KEY, S3_BUCKET=madizi-docs, S3_REGION=us-east-1

2ï¸âƒ£ Ce qui a Ã©tÃ© bÃ¢clÃ© / Ã  fiabiliser
Paiement PayPal

âœ… Handler de confirm + page /checkout/paypal-success crÃ©Ã©s (copie du flow Stripe)

âœ… Traductions checkoutPaypalSuccess ajoutÃ©es / Ã  vÃ©rifier dans fr.json

â³ Ã€ faire / tester :

vÃ©rifier que payment_transactions est bien remplie (provider paypal)

vÃ©rifier que obituaries.payment_provider = 'paypal', amount_paid, currency sont bien mis Ã  jour

tester le retour â€œRetour sur Madiziâ€ depuis PayPal (URL, auth, erreurs)

Virement bancaire

âœ… /api/payments/checkout renvoie un bloc bankTransfer avec IBAN, etc.

âœ… /checkout/obituary/[slug] affiche les instructions si provider bank_transfer

â³ Reste Ã  faire :

prÃ©voir un process manuel admin : marquer la transaction comme succeeded quand le virement arrive, et mettre Ã  jour lâ€™annonce

Ã©ventuellement un statut spÃ©cial : status = 'pending_review', verification_status = 'pending'

ModÃ©ration / publication aprÃ¨s paiement

Aujourdâ€™hui :

aprÃ¨s paiement Stripe/PayPal, on enregistre le paiement mais on ne publie pas :

status reste draft

verification_status nâ€™est pas encore pilotÃ© automatiquement

Ã€ faire :

quand docs + paiement OK :

cÃ´tÃ© admin : passer verification_status Ã  verified et status Ã  published Ã  la main (via une future interface).

cÃ´tÃ© front (compte utilisateur) :

afficher les annonces payÃ©es mais non publiÃ©es avec un badge â€œEn attente de validationâ€.

AccÃ¨s admin aux documents

on stocke file_url type s3://...

on nâ€™a pas encore :

de route admin pour lister les documents,

ni dâ€™endpoint pour tÃ©lÃ©charger/streamer la CNI / certificat de dÃ©cÃ¨s.

3ï¸âƒ£ Roadmap courte (Ã  garder sous les yeux)
Court terme (avant dâ€™ajouter de nouvelles features)

Fiabiliser PayPal

 Finir les traductions checkoutPaypalSuccess dans fr.json (si pas fait Ã  100%)

 Tester un paiement PayPal complet (sandbox)

 VÃ©rifier lâ€™update de payment_transactions + obituaries comme pour Stripe

 GÃ©rer le cas dâ€™erreur proprement sur /checkout/paypal-success

Affiner la page de confirmation

 Charger les documents existants au mount (GET /api/obituaries/:slug/documents) pour afficher â€œâœ… dÃ©jÃ  transmisâ€

 VÃ©rifier que hasAllRequiredDocs se base bien sur la rÃ©ponse API (et pas juste sur lâ€™Ã©tat local)

 Afficher un petit badge â€œdocs OKâ€ dans la colonne de droite si les 2 sont prÃ©sents

Nettoyage UX / i18n

 VÃ©rifier tous les messages dâ€™erreur / toasts pour :

upload documents

paiement Stripe

paiement PayPal

 Sâ€™assurer que les textes parlent bien de Madizi (et plus â€œMatangaâ€)

Moyen terme (backoffice + statuts)

Page â€œMes annoncesâ€ (cÃ´tÃ© user)

 Route /account/obituaries ou similaire

 Liste des annonces de lâ€™utilisateur avec :

titre, ville, dates

plan

Ã©tat : draft, en attente de validation, publiÃ©e, refusÃ©e, archivÃ©e

badge â€œPaiement confirmÃ©â€ si amount_paid > 0

 Lien pour retourner :

Ã  la page de confirmation

Ã  la page publique quand published

Backoffice admin / modÃ©ration

 Route /admin/obituaries (protÃ©gÃ©e par rÃ´le admin/moderator)

 Liste filtrable :

annonces payÃ©es (amount_paid > 0)

verification_status = pending

 Page dÃ©tail admin :

infos dÃ©funt, texte, Ã©vÃ©nements, contacts

infos de paiement (provider, montant, currency, payment_id)

documents justificatifs (liens vers une route /api/admin/obituaries/:id/documents/:docId/download)

actions :

â€œValider et publierâ€ â†’ verification_status = 'verified', status = 'published', published_at = NOW()

â€œRefuserâ€ â†’ verification_status = 'rejected', status = 'rejected', verification_note rempli

AccÃ¨s aux docs (admin only)

 Endpoint admin pour lister les docs :

GET /api/admin/obituaries/:id/documents

 Endpoint admin pour tÃ©lÃ©charger :

GET /api/admin/obituaries/:id/documents/:docId/download

qui fait un GetObject S3 et stream le fichier vers le navigateur